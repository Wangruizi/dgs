<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”é€šâ€œé€šé€šâ€çš„å¥‡å¦™ä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Prevent pull-to-refresh issues on mobile */
        }
        /* Base style for all sections: hidden by default */
        .section {
            min-height: 100vh;
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            position: relative; 
        }
        /* Style for the currently active section: make it visible and a flex container */
        .active-section {
            display: flex;
        }

        /* Global back button style */
        .global-back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s, transform 0.2s, opacity 0.3s, filter 0.3s;
        }
        .global-back-button img {
            width: 40px; 
            height: 40px; 
        }
        .global-back-button:hover:not(.disabled) {
            background-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }
        .global-back-button.disabled {
            opacity: 0.5;
            filter: blur(1px);
            pointer-events: none;
            cursor: default;
        }

        /* Styles for Tongtong hotspot interaction */
        .tongtong-hotspot-container {
            position: relative;
            width: 300px; 
            height: 300px; 
            margin-bottom: 20px;
            background-color: #f0f0f0; 
        }
        .tongtong-hotspot-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            border-radius: 12px;
        }
        .hotspot {
            position: absolute;
            width: 35px;
            height: 35px;
            background-color: rgba(255, 102, 0, 0.9); 
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem; 
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s ease-in-out, background-color 0.2s, opacity 0.3s, filter 0.3s; /* Added opacity and filter */
        }
        .hotspot:hover {
            transform: scale(1.15);
            background-color: rgba(230, 80, 0, 1); 
        }
        .hotspot-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000; 
            width: 85%;
            max-width: 380px;
            display: none; 
        }
        /* Styles for the clicker game area */
        .game-area {
            width: 100%;
            max-width: 400px; 
            height: 300px; 
            background-color: #fff0e6; 
            border-radius: 12px;
            position: relative;
            overflow: visible; 
            margin-top: 15px;
            margin-bottom: 15px;
            border: 3px solid #FF6600; 
        }
        .game-tongtong {
            position: absolute;
            width: 60px;
            height: 60px;
            background-image: url('xia.png'); 
            background-color: #FFFACD; 
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 50%;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.2s;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
        }
        .game-tongtong:hover {
            transform: scale(1.1);
        }
        .game-info {
            font-size: 1.125rem; 
            color: #555;
            margin-bottom: 10px;
        }
        .game-info span {
            font-weight: bold;
            color: #FF6600; 
        }

        /* Styles for product grid */
        .product-grid-container {
            width: 100%; 
            overflow: hidden; 
        }
        .product-grid {
            display: flex;
            overflow-x: auto; 
            overflow-y: hidden; 
            scroll-snap-type: x mandatory; 
            -webkit-overflow-scrolling: touch; 
            padding: 20px 10px; 
            width: 100%; 
            box-sizing: border-box;
        }
        .product-grid::-webkit-scrollbar { height: 8px; }
        .product-grid::-webkit-scrollbar-thumb { background: #FF6600; border-radius: 4px; }
        .product-grid::-webkit-scrollbar-track { background: #ffe8cc; border-radius: 4px; }

        .product-item {
            flex: 0 0 300px; 
            max-width: 320px; 
            height: auto;
            min-height: 380px; 
            background-color: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-right: 15px; 
            scroll-snap-align: center; 
            scroll-snap-stop: always; 
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .product-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .product-item:last-child { margin-right: 0; } 
        .product-item img {
            width: 100%;
            height: 200px; 
            object-fit: cover; 
            border-radius: 12px;
            margin-bottom: 16px;
            background-color: #e0e0e0; 
        }
        .product-item h3 { font-size: 1.25rem; font-weight: 600; color: #333; line-height: 1.4; margin-bottom: 8px; }
        .product-item-short-desc {
            font-size: 0.9rem; 
            color: #555;
            line-height: 1.5;
            margin-bottom: 10px;
            flex-grow: 1; 
            text-align: center; 
        }
        .product-item p.static-description { 
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
            flex-grow: 1;
            margin-bottom: 10px;
            text-align: left; 
            display: none; 
        }
        .product-item-price { font-size: 1rem; font-weight: bold; color: #FF6600; margin-top: auto; }

        /* Button styles */
        .button-primary, .button-secondary { /* Combined for shared properties */
            padding: 10px 20px; 
            border-radius: 9999px; 
            font-weight: 600; 
            text-decoration: none; 
            display: inline-block; 
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.1s ease-in-out, opacity 0.3s, filter 0.3s; /* Added opacity and filter */
            border: none; 
            cursor: pointer;
        }
        .button-primary {
            background-color: #FF6600; color: white; padding: 12px 24px; margin-top: 20px;
        }
        .button-primary:hover:not([style*="pointer-events: none"]) { background-color: #E65C00; } /* Check for disabled state */
        
        .button-secondary {
            background-color: #FFA500; color: white;  margin-right: 10px;
        }
        .button-secondary:hover:not([style*="pointer-events: none"]) { background-color: #FF8C00; }


        /* General Modal styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: 15px; box-sizing: border-box;
        }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 16px; text-align: center;
            width: 90%; max-width: 450px; box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            position: relative; max-height: 90vh; overflow-y: auto; 
        }
        .modal-content h3 { font-size: 1.5rem; font-weight: 700; color: #FF6600; margin-bottom: 15px; }
        .modal-content p { margin-bottom: 20px; font-size: 1rem; color: #333; line-height: 1.6; }
        
        .modal-close-button { 
            position: absolute; top: 10px; right: 10px; background: #eee; color: #333; border: none;
            border-radius: 50%; width: 30px; height: 30px; font-size: 18px; line-height: 30px;
            text-align: center; cursor: pointer; font-weight: bold;
        }
        .modal-close-button:hover { background: #ddd; }

        /* Product Detail Modal specific styles */
        #productDetailModal { backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        #productDetailModal .modal-content { max-width: 500px; }
        #productDetailModal .modal-close-button { 
            position: sticky; /* MODIFIED: Changed from absolute to sticky */
            top: 15px; 
            right: 15px; 
            /* The button needs to be a direct child or appropriately positioned for sticky to work relative to scroll container */
            /* If .modal-content is the scroll container, this should stick to its top-right */
            float: right; /* ADDED: to help ensure it stays on the right */
            margin-bottom: -35px; /* ADDED: to pull it up if content flows around it, adjust as needed */
            background: rgba(230, 230, 230, 0.9);
            color: #333;
            border: none;
            border-radius: 50%;
            width: 35px; 
            height: 35px;
            font-size: 20px;
            line-height: 35px; 
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            z-index: 20; /* Increased z-index to ensure it's above other content within modal-content */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #productDetailModal .modal-close-button:hover {
            background: rgba(220, 220, 220, 1);
        }

        #productDetailImage {
            width: 100%; max-height: 300px; object-fit: contain; border-radius: 12px;
            margin-bottom: 20px; background-color: #f9f9f9; 
            margin-top: 10px; /* ADDED: To prevent overlap with sticky button if it's the very first item */
        }
        #productDetailName { font-size: 1.75rem; font-weight: 700; color: #FF6600; margin-bottom: 10px; clear: both; /* ADDED: In case of float issues from button */ }
        #productDetailDescription { font-size: 1rem; color: #555; margin-bottom: 15px; min-height: 50px; text-align: left; clear: both; }
        #productDetailPrice { font-size: 1.5rem; font-weight: bold; color: #E65C00; margin-bottom: 25px; clear: both; }
        #ai-description-loader {
            font-size: 0.9rem;
            color: #666;
            margin: 10px 0;
        }

        /* Maze game styles */
        #mazeCanvas {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: block; 
            margin-left: auto;
            margin-right: auto;
        }
        .maze-canvas-wrapper {
            position: relative; 
            width: 300px; 
            height: 300px; 
            margin-left: auto;
            margin-right: auto;
            overflow: hidden; 
            border-radius: 12px;
            background-image: url('mgbg2.png'); 
            background-size: cover;
            background-position: center;
            border: 2px solid #A855F7; 
        }
        .maze-arrow-button {
            background-color: #A855F7; color: white; padding: 0.75rem; border-radius: 9999px;
            font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; justify-content: center;
            transition: transform 0.1s ease-in-out, background-color 0.3s ease-in-out;
            border: none; cursor: pointer; width: 60px; height: 60px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .maze-arrow-button:hover { background-color: #9333EA;  }
        .maze-arrow-button.pressed { transform: scale(0.9); background-color: #7E22CE; }

        .game-timer-info { font-size: 1.125rem; color: #4B0082; margin-bottom: 10px; } 
        .game-timer-info span { font-weight: bold; color: #6D28D9; }

        /* Music toggle button style */
        .music-toggle-button {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: background-color 0.3s, transform 0.1s;
        }
        .music-toggle-button:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }
        .music-toggle-button img { width: 20px; height: 20px; display: block; }

        #match-game-music-toggle {
            margin-left: 8px; 
        }

        /* QR Code Modal specific styles */
        #qrCodeModal .modal-content {
            max-width: 380px;
        }
        #qrCodeImage {
            width: 100%;
            max-width: 280px; 
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        /* Styles for Match-3 Game (æ¶ˆæ¶ˆä¹) */
        #section-match-game {
            color: #333;
            font-family: 'Inter', 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
        }
        #section-match-game h1 {
            margin-top: 20px; 
            color: #166534; 
            font-size: 2em; 
        }
        #section-match-game .desc {
            color: #374151; 
            margin-bottom: 15px;
            text-align: center;
            max-width: 500px; 
            font-size: 0.9em; 
        }
        #section-match-game .stats-container {
            display: flex;
            justify-content: center; 
            align-items: center;
            width: 100%;
            max-width: 480px; 
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 15px;
            font-size: 1em; 
            gap: 10px; 
        }
        #section-match-game #score,
        #section-match-game #timer,
        #section-match-game #hint-count-display {
            background-color: #ffffff;
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            font-weight: 500;
        }
        #section-match-game #timer { color: #c0392b; } 
        #section-match-game #score { color: #15803d; } 
        #section-match-game #hint-count-display { color: #2563eb; } 

        #section-match-game .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center; 
            width: 100%;
            max-width: 480px; 
            margin-left: auto;
            margin-right: auto;
        }
        
        #section-match-game #game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr); 
            grid-template-rows: repeat(8, 1fr);    
            gap: 6px; 
            background-color: #bbf7d0; 
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            padding: 6px; 
            width: 95%; 
            aspect-ratio: 1 / 1; 
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
            max-width: 500px; 
        }
        
        #section-match-game .cell {
            background: #a7f3d0; 
            border: none; 
            border-radius: 12px; 
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s;
            overflow: hidden; 
            margin: 0; 
            padding: 0; 
            position: relative; 
        }
        
        #section-match-game .cell.selected {
            box-shadow: 0 0 0 3px #f59e0b; 
            transform: scale(1.05);
            border-radius: 12px; 
            z-index: 2; 
        }
        
        #section-match-game .cell img {
            width: 96%; 
            height: 96%;
            object-fit: cover; 
            object-position: center;
            border: none; 
            border-radius: 10px; 
            pointer-events: none; 
            user-select: none; 
            display: block; 
        }
        /* Match-3 Animations */
        #section-match-game .cell.disappear { animation: xxl-disappear 0.4s forwards; }
        @keyframes xxl-disappear {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.2); }
        }
        #section-match-game .cell.fall { animation: xxl-fall 0.4s cubic-bezier(.4,1.4,.6,1) forwards; }
        @keyframes xxl-fall {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Match-3 Control Buttons */
        #section-match-game .controls .game-button,
        #section-match-game #match-game-to-products-btn {
            color: white; padding: 10px 20px; border-radius: 9999px; 
            font-weight: 600; text-decoration: none; display: inline-block;
            transition: background-color 0.3s, transform 0.1s ease-in-out;
            border: none; cursor: pointer; font-size: 1em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #section-match-game .controls .game-button:hover:not(:disabled),
        #section-match-game #match-game-to-products-btn:hover:not(:disabled) {
            transform: translateY(-1px); 
        }
        #section-match-game .controls .game-button:active,
        #section-match-game #match-game-to-products-btn:active {
             transform: translateY(1px); 
        }
        #section-match-game .controls .game-button:disabled,
        #section-match-game #match-game-to-products-btn:disabled {
            background-color: #9ca3af; color: #e5e7eb; 
            cursor: not-allowed; transform: none; box-shadow: none;
        }
        #section-match-game #action-btn { background-color: #22c55e; } 
        #section-match-game #action-btn:hover:not(:disabled) { background-color: #16a34a; } 
        #section-match-game #hint-btn { background-color: #3b82f6; } 
        #section-match-game #hint-btn:hover:not(:disabled) { background-color: #2563eb; } 
        #section-match-game #match-game-to-products-btn {
            background-color: #f97316; 
        }
        #section-match-game #match-game-to-products-btn:hover:not(:disabled) { background-color: #ea580c; }        
        /* Hint Highlight Styles */
        #section-match-game .hint {
            box-shadow: 0 0 0 3px #00e0ff, 0 0 12px 4px #ffffff, 0 0 0 8px #ffffff00 inset; 
            outline: 2px solid #00e0ff; outline-offset: -2px;
            border-radius: 12px; 
            position: relative; z-index: 4;  animation: xxl-hint-pulse 0.7s infinite alternate;
        }
        @keyframes xxl-hint-pulse {
            0% { box-shadow: 0 0 0 3px #00e0ff, 0 0 12px 4px #ffffff, 0 0 0 8px #ffffff00 inset; }
            100% { box-shadow: 0 0 0 7px #00e0ff, 0 0 18px 8px #ffffff, 0 0 0 12px #ffffff00 inset; }
        }
        #section-match-game .hint-animate { animation: xxl-hint-swap 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) 2 alternate; }
        @keyframes xxl-hint-swap { 
            0% { transform: none; }
            50% { transform: scale(1.15) translate(var(--xxl-hint-x,0), var(--xxl-hint-y,0)); }
            100% { transform: none; }
        }
        /* Cell Swap Animations */
        #section-match-game .cell.swap { transition: transform 0.25s ease-in-out; z-index: 10; }
        #section-match-game .cell.swap-back-half { transition: transform 0.13s ease-out; z-index: 10; }
        #section-match-game .cell.swap-back { transition: transform 0.13s ease-in; z-index: 10; }

        /* Match-3 Message Box */
        #section-match-game .message-box-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        #section-match-game .message-box-overlay.visible { opacity: 1; visibility: visible; }
        #section-match-game .message-box {
            background-color: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 80%;
        }
        #section-match-game .message-box p { margin: 0 0 15px 0; font-size: 1.1em; color: #333; }
        #section-match-game .message-box button#message-box-ok {
            background-color: #16a34a; color: white; border: none; 
            border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: 500;
        }
        #section-match-game .message-box button#message-box-ok:hover {
            background-color: #15803d; transform: translateY(-1px); 
        }

        /* Styles for the new Chat Modal */
        #tongtong-chat-modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 450px; 
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1002; 
            display: none; 
            flex-direction: column; 
        }
        #tongtong-chat-modal-container h3 { 
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #0EA5E9; 
            margin-bottom: 0.75rem; 
            text-align: center;
        }
        #chat-history-modal { 
            height: 250px; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.375rem; 
            padding: 0.75rem; 
            overflow-y: auto;
            margin-bottom: 0.75rem; 
            background-color: #f9fafb; 
        }
        .chat-message-modal { 
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            max-width: 90%; 
            word-wrap: break-word;
            line-height: 1.5;
        }
        .user-message-modal {
            background-color: #F0F9FF; 
            color: #075985;    
            margin-left: auto;
            text-align: right;
        }
        .ai-message-modal {
            background-color: #F5F3FF; 
            color: #5B21B6;    
            margin-right: auto;
            text-align: left;
            display: flex; 
            align-items: flex-start; 
            gap: 8px; 
        }
        .chat-avatar {
            width: 28px; 
            height: 28px;
            border-radius: 50%;
            flex-shrink: 0; 
            margin-top: 2px; 
        }
        .message-text-modal { 
            flex-grow: 1;
        }

        #chat-input-modal-wrapper { 
            display: flex;
            gap: 0.5rem; 
            margin-top: 0.75rem; 
        }
        #chat-input-modal { 
            flex-grow: 1;
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            padding: 0.5rem 0.75rem; 
            min-width: 0; 
        }
        #chat-input-modal:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #0EA5E9; 
            box-shadow: 0 0 0 2px #7DD3FC; 
        }
        #close-chat-modal-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #9ca3af; 
            cursor: pointer;
            line-height: 1;
            padding: 0.25rem;
        }
        #close-chat-modal-btn:hover {
            color: #4b5563; 
        }
         #chat-loading-modal { 
            display:none;
            font-size: 0.875rem; 
            color: #6b7280; 
            margin-top: 0.5rem; 
            text-align: center;
        }


        /* Responsive adjustments */
        @media (max-width: 600px) {
            /* Match-3 game responsive styles */
            #section-match-game h1 { font-size: 1.5em; }
            #section-match-game .desc { font-size: 0.8em; }
            #section-match-game .stats-container {
                font-size: 0.85em; flex-direction: column; 
                gap: 8px; align-items: center; 
            }
            #section-match-game .controls .game-button,
            #section-match-game #match-game-to-products-btn,
            #section-match-game .message-box button#message-box-ok { padding: 8px 15px; font-size: 0.9em; }
            #section-match-game .controls { flex-wrap: wrap; justify-content: center;} 

            /* Maze game responsive styles */
            #section-maze .flex-col-reverse-sm { 
                display: flex;
                flex-direction: column-reverse;
            }
            
            #maze-game-controls { 
                order: 1; 
                margin-bottom: 0.75rem; 
            }
            #maze-controls-mobile { 
                order: 2; 
            }
        }
    </style>
</head>
<body class="bg-orange-50">

    <div id="global-back-button" class="global-back-button" onclick="navigateBack()" style="display:none;">
        <img src="back.png" alt="è¿”å›" onerror="this.style.display='none'; this.parentElement.innerHTML = '<span style=\'font-size:20px;\'>â†</span>'">
    </div>

    <section id="section-welcome" class="section active-section bg-gradient-to-br from-orange-400 to-red-500 text-white">
        <div class="flex flex-col items-center">
            <img src="liantongwenchuang.png" alt="é€šé€šå‰ç¥¥ç‰©" class="w-48 h-48 md:w-64 md:h-64 rounded-full shadow-2xl mb-8 animate-bounce" onerror="this.alt='è”é€šæ–‡åˆ›Logo'; this.style.backgroundColor='#ccc';">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">é‡è§é€šé€š</h1>
            <p class="text-lg md:text-xl mb-8">å¼€å¯ä½ çš„å¥‡å¦™æ–‡åˆ›ä¹‹æ—…ï¼</p>
            <button onclick="navigateTo('section-explore')" class="bg-white text-orange-600 border-2 border-orange-600 hover:bg-orange-50 text-lg font-semibold py-3 px-8 rounded-full shadow-md hover:shadow-lg transition-transform transform hover:scale-105">å¼€å§‹æ¢ç´¢</button>
        </div>
    </section>

    <section id="section-explore" class="section bg-orange-100">
        <h2 class="text-3xl font-bold text-orange-600 mb-6">è®¤è¯†é€šé€š</h2>
        <p class="mb-4 text-gray-700">ç‚¹å‡»é€šé€šèº«ä¸Šçš„äº®ç‚¹ï¼Œå‘ç°æ›´å¤šæƒŠå–œï¼</p>
        <div class="tongtong-hotspot-container bg-white p-2 rounded-2xl shadow-lg">
            <img src="zm.png"
                 alt="é€šé€šäº’åŠ¨å½¢è±¡"
                 id="tongtong-interactive-image"
                 onerror="this.alt='é€šé€šå›¾ç‰‡'; this.style.backgroundColor='#ddd';"
                 >
            <div class="hotspot explore-interactive" style="top: 0%; left: 15%;" onclick="showHotspotInfo('é€šé€šçš„è§¦è§’', 'è¿™å¯¹å¯çˆ±çš„è§¦è§’ï¼Œè±¡å¾ç€è”é€šæºæºä¸æ–­çš„ä¿¡æ¯ä¸èƒ½é‡')">1</div>
            <div class="hotspot explore-interactive" style="top: 25%; left: 80%;" onclick="showHotspotInfo('é€šé€šçš„ç¬‘è„¸', 'é€šé€šæ—¶åˆ»ä¿æŒå¾®ç¬‘ï¼Œä¸ºæ‚¨æä¾›æœ€è´´å¿ƒçš„æœåŠ¡ã€‚')">2</div>
            <div class="hotspot explore-interactive" style="top: 75%; left: 75%;" onclick="showHotspotInfo('æ‹ŸäººåŒ–å¤–è§‚', 'è‰²è°ƒä¸ºè”é€šä¸­å›½çº¢ï¼Œä»¥æœºå™¨äººä¸ºåŸå‹ï¼Œèåˆç°ä»£ç§‘æŠ€ä¸äººæ€§åŒ–è®¾è®¡ï¼Œå¢å¼ºäº†é€šé€šçš„äº²å’ŒåŠ›å’Œç§‘æŠ€æ„Ÿ')">3</div>
        </div>
        <div id="hotspot-popup" class="hotspot-popup">
            <h3 id="hotspot-title" class="text-xl font-semibold text-orange-600 mb-2"></h3>
            <p id="hotspot-text" class="text-gray-700 mb-4"></p>
            <div id="ai-hotspot-loading" style="display:none;" class="text-sm text-gray-500 my-2">âœ¨ é€šé€šæ­£åœ¨è§£è¯»å¥¥ç§˜...</div>
            <div id="ai-hotspot-content" class="mt-2"></div>
            <button id="enhance-hotspot-btn" class="button-secondary text-sm mt-3 w-full">âœ¨ AIè§£è¯»é€šé€šæ›´å¤šå¥¥ç§˜</button>
            <button onclick="closeHotspotInfo()" class="button-primary text-sm mt-2">å…³é—­</button>
        </div>

        <div class="flex flex-col sm:flex-row flex-wrap justify-center gap-4 mt-8">
            <button onclick="navigateTo('section-match-game')" class="button-primary bg-green-500 hover:bg-green-700 explore-interactive">æ–‡åˆ›æ¶ˆæ¶ˆä¹</button>
            <button onclick="navigateTo('section-game')" class="button-primary explore-interactive">é€šé€šå¿«æ‰‹ç‚¹å‡»</button>
            <button onclick="navigateTo('section-maze')" class="button-primary bg-purple-600 hover:bg-purple-700 explore-interactive">æŒ‘æˆ˜é€šé€šè¿·å®«</button>
        </div>

        <button id="tongtong-chat-toggle-button" class="button-primary bg-sky-500 hover:bg-sky-600 py-2 px-4 text-base !mt-6 explore-interactive">ğŸ’¬ å’Œé€šé€šèŠèŠå¤©</button>
    </section>

    <div id="tongtong-chat-modal-container">
        <button id="close-chat-modal-btn">&times;</button>
        <h3>å’Œé€šé€šèŠèŠå¤©</h3>
        <div id="chat-history-modal">
            <div class="ai-message-modal chat-message-modal">
                <img src="xia.png" alt="é€šé€šå¤´åƒ" class="chat-avatar" onerror="this.style.display='none';">
                <span class="message-text-modal">ä½ å¥½ï¼æˆ‘æ˜¯é€šé€šï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿï¼ˆé€šé€šçš„å›ç­”å¯èƒ½æœ‰è¯¯ï¼Œè¯·æ³¨æ„ç”„åˆ«ï¼‰</span>
            </div>
        </div>
        <div id="chat-input-modal-wrapper">
            <input type="text" id="chat-input-modal" placeholder="é—®é€šé€šä¸€äº›é—®é¢˜å§...">
            <button id="send-chat-modal-btn" class="button-primary bg-sky-500 hover:bg-sky-600 py-2 px-3 sm:px-4 text-sm !mt-0 flex-shrink-0">å‘é€</button>
        </div>
        <div id="chat-loading-modal">é€šé€šæ­£åœ¨æ€è€ƒ...</div>
    </div>


    <section id="section-game" class="section bg-red-100">
        <h2 class="text-3xl font-bold text-red-600 mb-4">é€šé€šå¿«æ‰‹ç‚¹å‡»</h2>
        
        <div class="w-full max-w-[400px] mx-auto relative mb-2">
            <div id="click-game-music-toggle" class="music-toggle-button absolute top-[50px] right-0 z-10">
                <img src="music_on.png" alt="Music On" onerror="this.parentElement.innerHTML = '<span style=\'font-size:12px;\'>ğŸµOn</span>';">
            </div>
        </div>

        <p class="game-info">å€’è®¡æ—¶: <span id="game-timer">10</span> ç§’</p>
        <p class="game-info">å¾—åˆ†: <span id="game-score">0</span></p>
        <div id="game-area" class="game-area" style="background-image: url('ksbg.png'); background-size: cover; background-position: center;">
            </div>
        <div id="game-controls" class="mt-4">
            <button id="start-game-btn" onclick="startGame()" class="button-primary text-lg">å¼€å§‹æ¸¸æˆ</button>
            <button id="to-products-btn" onclick="navigateTo('section-products')" class="button-secondary text-lg" style="display:none;">æŸ¥çœ‹æ–‡åˆ›äº§å“</button>
        </div>
    </section>

    <section id="section-products" class="section bg-orange-50">
        <h2 class="text-3xl font-bold text-orange-600 mb-6">é€šé€šçš„æ–‡åˆ›å®åº“</h2>
        <div class="product-grid-container">
            <div class="product-grid">
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥89" data-name="é€šé€šä¿æ¸©æ¯" 
                     data-description="è¿™æ˜¯ä¸€æ¬¾æ—¶å°šçš„ç™½è‰²é€šé€šä¸»é¢˜ä¿æ¸©æ¯ã€‚æ¯ä½“ä¸­å¤®å°æœ‰å¯çˆ±çš„æ©™è‰²é€šé€šå‰ç¥¥ç‰©å½¢è±¡ï¼ŒèƒŒæ™¯æ˜¯ç°ä»£éƒ½å¸‚çš„æ¥¼å®‡å‰ªå½±å›¾æ¡ˆï¼Œå¯Œæœ‰è®¾è®¡æ„Ÿã€‚æ¯ç›–ä¸ºå¼¹æ‰£å¼ï¼Œæ–¹ä¾¿å•æ‰‹å¼€å¯ã€‚æ•´ä½“æè´¨çœ‹èµ·æ¥å…‰æ»‘æœ‰è´¨æ„Ÿï¼Œé€‚åˆæ—¥å¸¸æºå¸¦ï¼Œä¸ºæ‚¨éšæ—¶é”ä½é¥®å“æ¸©åº¦ã€‚" 
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_ä¿æ¸©æ¯.(1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_ä¿æ¸©æ¯.(1).jpg" alt="é€šé€šä¿æ¸©æ¯" onerror="this.alt='ä¿æ¸©æ¯å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=ä¿æ¸©æ¯';">
                    <h3>é€šé€šä¿æ¸©æ¯</h3>
                    <p class="product-item-short-desc">æ—¶å°šè”é€šå®šåˆ¶ä¿æ¸©æ¯ï¼Œæ¸©æš–å¸¸ä¼´ï¼Œè®©çˆ±è”é€šã€‚</p>
                    <p class="static-description">è¿™æ˜¯ä¸€æ¬¾æ—¶å°šçš„ç™½è‰²é€šé€šä¸»é¢˜ä¿æ¸©æ¯ã€‚æ¯ä½“ä¸­å¤®å°æœ‰å¯çˆ±çš„æ©™è‰²é€šé€šå‰ç¥¥ç‰©å½¢è±¡ï¼ŒèƒŒæ™¯æ˜¯ç°ä»£éƒ½å¸‚çš„æ¥¼å®‡å‰ªå½±å›¾æ¡ˆï¼Œå¯Œæœ‰è®¾è®¡æ„Ÿã€‚æ¯ç›–ä¸ºå¼¹æ‰£å¼ï¼Œæ–¹ä¾¿å•æ‰‹å¼€å¯ã€‚æ•´ä½“æè´¨çœ‹èµ·æ¥å…‰æ»‘æœ‰è´¨æ„Ÿï¼Œé€‚åˆæ—¥å¸¸æºå¸¦ï¼Œä¸ºæ‚¨éšæ—¶é”ä½é¥®å“æ¸©åº¦ã€‚</p>
                    <p class="product-item-price">Â¥89</p>
                </div>
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥49" data-name="é€šé€šå……ç”µçº¿" 
                     data-description="è¿™æ˜¯ä¸€æ¬¾å……æ»¡æ´»åŠ›çš„æ©™è‰²é€šé€šä¸»é¢˜ä¸‰åˆä¸€å……ç”µçº¿ã€‚çº¿æé‡‡ç”¨èºæ—‹ä¼¸ç¼©è®¾è®¡ï¼Œä¾¿äºæ”¶çº³å’Œè°ƒèŠ‚é•¿åº¦ã€‚å……ç”µçº¿ä¸€ç«¯æ¥å£å¤„è®¾è®¡ä¸ºå¯çˆ±çš„é€šé€šå…¬ä»”å¤´åƒé€ å‹ï¼Œå¤§çœ¼ç›ï¼Œå¤´é¡¶æœ‰ç™½è‰²å°è§¦è§’ï¼Œéå¸¸èŒè¶£ã€‚å¦ä¸€ç«¯æ˜¯USB-Aæ¥å£ï¼Œé€‚ç”¨äºå¤šç§å……ç”µåœºæ™¯ã€‚"
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_å……ç”µçº¿(1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_å……ç”µçº¿(1).jpg" alt="é€šé€šå……ç”µçº¿" onerror="this.alt='å……ç”µçº¿å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=å……ç”µçº¿';">
                    <h3>é€šé€šå……ç”µçº¿</h3>
                    <p class="product-item-short-desc">ä¾¿æ·ä¸‰åˆä¸€å……ç”µçº¿ï¼Œå…¼å®¹å¤šç§è®¾å¤‡ï¼Œå‡ºè¡Œæ— å¿§ã€‚</p>
                    <p class="static-description">è¿™æ˜¯ä¸€æ¬¾å……æ»¡æ´»åŠ›çš„æ©™è‰²é€šé€šä¸»é¢˜ä¸‰åˆä¸€å……ç”µçº¿ã€‚çº¿æé‡‡ç”¨èºæ—‹ä¼¸ç¼©è®¾è®¡ï¼Œä¾¿äºæ”¶çº³å’Œè°ƒèŠ‚é•¿åº¦ã€‚å……ç”µçº¿ä¸€ç«¯æ¥å£å¤„è®¾è®¡ä¸ºå¯çˆ±çš„é€šé€šå…¬ä»”å¤´åƒé€ å‹ï¼Œå¤§çœ¼ç›ï¼Œå¤´é¡¶æœ‰ç™½è‰²å°è§¦è§’ï¼Œéå¸¸èŒè¶£ã€‚å¦ä¸€ç«¯æ˜¯USB-Aæ¥å£ï¼Œé€‚ç”¨äºå¤šç§å……ç”µåœºæ™¯ã€‚</p>
                    <p class="product-item-price">Â¥49</p>
                </div>
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥29" data-name="é€šé€šåœ°çƒé’¥åŒ™æ‰£" 
                     data-description="è¿™æ¬¾é€šé€šåœ°çƒæ¢ç´¢ä¸»é¢˜é’¥åŒ™æ‰£ï¼Œä¸»ä½“ä¸ºåœ†å½¢é‡‘å±å¾½ç« è®¾è®¡ã€‚å¾½ç« ä¸Šå±‚æ˜¯æ·±è“è‰²å¤œç©ºèƒŒæ™¯ä¸‹çš„åœ°çƒå›¾æ¡ˆï¼Œä¸Šé¢ç«™ç«‹ç€æ‰‹æŒç¬”è®°æœ¬ç”µè„‘çš„é€šé€šå…¬ä»”ï¼Œå‘¨å›´ç‚¹ç¼€ç€é—ªäº®çš„ä»¿æ°´é’»ã€‚é’¥åŒ™æ‰£é…æœ‰é‡‘è‰²é¾™è™¾æ‰£ï¼Œæ–¹ä¾¿æŒ‚å–ã€‚æ•´ä½“è®¾è®¡ç²¾è‡´ï¼Œå¯Œæœ‰ç§‘æŠ€æ„Ÿå’Œæ¢ç´¢ç²¾ç¥ã€‚"
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_åœ°çƒæ¬¾é’¥åŒ™æ‰£(1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_åœ°çƒæ¬¾é’¥åŒ™æ‰£(1).jpg" alt="é€šé€šåœ°çƒé’¥åŒ™æ‰£" onerror="this.alt='åœ°çƒé’¥åŒ™æ‰£å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=åœ°çƒé’¥åŒ™æ‰£';">
                    <h3>é€šé€šåœ°çƒé’¥åŒ™æ‰£</h3>
                    <p class="product-item-short-desc">ç²¾è‡´åœ°çƒé€ å‹é’¥åŒ™æ‰£ï¼Œè”é€šä¸–ç•Œï¼Œç‚¹ç¼€ç”Ÿæ´»ã€‚</p>
                    <p class="static-description">è¿™æ¬¾é€šé€šåœ°çƒæ¢ç´¢ä¸»é¢˜é’¥åŒ™æ‰£ï¼Œä¸»ä½“ä¸ºåœ†å½¢é‡‘å±å¾½ç« è®¾è®¡ã€‚å¾½ç« ä¸Šå±‚æ˜¯æ·±è“è‰²å¤œç©ºèƒŒæ™¯ä¸‹çš„åœ°çƒå›¾æ¡ˆï¼Œä¸Šé¢ç«™ç«‹ç€æ‰‹æŒç¬”è®°æœ¬ç”µè„‘çš„é€šé€šå…¬ä»”ï¼Œå‘¨å›´ç‚¹ç¼€ç€é—ªäº®çš„ä»¿æ°´é’»ã€‚é’¥åŒ™æ‰£é…æœ‰é‡‘è‰²é¾™è™¾æ‰£ï¼Œæ–¹ä¾¿æŒ‚å–ã€‚æ•´ä½“è®¾è®¡ç²¾è‡´ï¼Œå¯Œæœ‰ç§‘æŠ€æ„Ÿå’Œæ¢ç´¢ç²¾ç¥ã€‚</p>
                    <p class="product-item-price">Â¥29</p>
                </div>
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥129" data-name="é€šé€šæ¯›ç»’ç©å…·" 
                     data-description="è¿™æ˜¯ä¸€æ¬¾éå¸¸å¯çˆ±çš„é€šé€šå‰ç¥¥ç‰©æ¯›ç»’å…¬ä»”ã€‚å…¬ä»”é€šä½“ä¸ºæ ‡å¿—æ€§çš„è”é€šæ©™è‰²ï¼Œå¤´éƒ¨æˆ´ç€å¸¦æœ‰ç™½è‰²è§¦è§’çš„å¤´ç›”ï¼Œéœ²å‡ºåœ†åœ†çš„å¤§çœ¼ç›å’Œå¾®ç¬‘çš„å˜´å·´ã€‚å…¬ä»”ä¸ºç«™ç«‹å§¿åŠ¿ï¼Œä¸€åªæ‰‹ä¸¾èµ·å‘æ‚¨æ‹›æ‰‹ï¼Œå¦ä¸€åªæ‰‹è‡ªç„¶ä¸‹å‚ã€‚æè´¨çœ‹èµ·æ¥æŸ”è½¯èˆ’é€‚ï¼Œé€‚åˆæ‹¥æŠ±å’Œç©è€ã€‚"
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_å‰ç¥¥ç‰©æ¯›ç»’ç©å…·(1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_å‰ç¥¥ç‰©æ¯›ç»’ç©å…·(1).jpg" alt="é€šé€šæ¯›ç»’ç©å…·" onerror="this.alt='æ¯›ç»’ç©å…·å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=æ¯›ç»’ç©å…·';">
                    <h3>é€šé€šæ¯›ç»’ç©å…·</h3>
                    <p class="product-item-short-desc">è¶…èŒé€šé€šå‰ç¥¥ç‰©å…¬ä»”ï¼ŒæŸ”è½¯äº²è‚¤ï¼Œé€ç¤¼ä½³é€‰ã€‚</p>
                    <p class="static-description">è¿™æ˜¯ä¸€æ¬¾éå¸¸å¯çˆ±çš„é€šé€šå‰ç¥¥ç‰©æ¯›ç»’å…¬ä»”ã€‚å…¬ä»”é€šä½“ä¸ºæ ‡å¿—æ€§çš„è”é€šæ©™è‰²ï¼Œå¤´éƒ¨æˆ´ç€å¸¦æœ‰ç™½è‰²è§¦è§’çš„å¤´ç›”ï¼Œéœ²å‡ºåœ†åœ†çš„å¤§çœ¼ç›å’Œå¾®ç¬‘çš„å˜´å·´ã€‚å…¬ä»”ä¸ºç«™ç«‹å§¿åŠ¿ï¼Œä¸€åªæ‰‹ä¸¾èµ·å‘æ‚¨æ‹›æ‰‹ï¼Œå¦ä¸€åªæ‰‹è‡ªç„¶ä¸‹å‚ã€‚æè´¨çœ‹èµ·æ¥æŸ”è½¯èˆ’é€‚ï¼Œé€‚åˆæ‹¥æŠ±å’Œç©è€ã€‚</p>
                    <p class="product-item-price">Â¥129</p>
                </div>
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥199" data-name="é‡‘è‰²é€šé€šæ‰‹åŠ" 
                     data-description="è¿™æ¬¾æ˜¯é™é‡ç‰ˆçš„é‡‘è‰²é€šé€šæ‰‹åŠæ‘†ä»¶ã€‚é€šé€šå…¬ä»”å…¨èº«å‘ˆç°é—ªäº®çš„é‡‘è‰²é‡‘å±å…‰æ³½ï¼Œé€ å‹ä¸ºç»å…¸çš„æ‹›æ‰‹å§¿åŠ¿ï¼Œè¡¨æƒ…å¯çˆ±ã€‚æ‰‹åŠç«™ç«‹åœ¨ä¸€ä¸ªåœ†æŸ±å½¢çš„é‡‘è‰²åº•åº§ä¸Šï¼Œåº•åº§ä¸Šåˆ»æœ‰'é€šé€š'å­—æ ·ã€‚æ•´ä½“å°å·§ç²¾è‡´ï¼Œå…·æœ‰æ”¶è—ä»·å€¼å’Œé«˜çº§æ„Ÿã€‚"
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_é‡‘è‰²é€šé€šæ‰‹åŠ(1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_é‡‘è‰²é€šé€šæ‰‹åŠ(1).jpg" alt="é‡‘è‰²é€šé€šæ‰‹åŠ" onerror="this.alt='é‡‘è‰²æ‰‹åŠå›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=é‡‘è‰²æ‰‹åŠ';">
                    <h3>é‡‘è‰²é€šé€šæ‰‹åŠ</h3>
                    <p class="product-item-short-desc">é™é‡ç‰ˆé‡‘è‰²é€šé€šæ‰‹åŠï¼Œç²¾è‡´æ”¶è—ï¼Œå½°æ˜¾å“å‘³ã€‚</p>
                    <p class="static-description">è¿™æ¬¾æ˜¯é™é‡ç‰ˆçš„é‡‘è‰²é€šé€šæ‰‹åŠæ‘†ä»¶ã€‚é€šé€šå…¬ä»”å…¨èº«å‘ˆç°é—ªäº®çš„é‡‘è‰²é‡‘å±å…‰æ³½ï¼Œé€ å‹ä¸ºç»å…¸çš„æ‹›æ‰‹å§¿åŠ¿ï¼Œè¡¨æƒ…å¯çˆ±ã€‚æ‰‹åŠç«™ç«‹åœ¨ä¸€ä¸ªåœ†æŸ±å½¢çš„é‡‘è‰²åº•åº§ä¸Šï¼Œåº•åº§ä¸Šåˆ»æœ‰'é€šé€š'å­—æ ·ã€‚æ•´ä½“å°å·§ç²¾è‡´ï¼Œå…·æœ‰æ”¶è—ä»·å€¼å’Œé«˜çº§æ„Ÿã€‚</p>
                    <p class="product-item-price">Â¥199</p>
                </div>
                 <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥25" data-name="é€šé€šæ‰‹æœºæŒ‚ç»³" 
                      data-description="è¿™æ˜¯ä¸€æ¬¾å®ç”¨åˆæ—¶å°šçš„é€šé€šä¸»é¢˜æ‰‹æœºæŒ‚ç»³ã€‚æŒ‚ç»³ä¸»ä½“ä¸ºçº¢ç™½ç›¸é—´çš„ç¼–ç»‡ç»³ï¼Œä¸Šé¢å°æœ‰è¿ç»­çš„é€šé€šå¤´åƒå›¾æ¡ˆã€‚è¿æ¥æ‰‹æœºçš„éƒ¨åˆ†æœ‰ä¸€ä¸ªå¯çˆ±çš„é€šé€šå…¬ä»”å¤´åƒä½œä¸ºè£…é¥°å’Œå›ºå®šæ‰£ï¼Œé€ å‹èŒè¶£ã€‚å¯ä»¥æœ‰æ•ˆé˜²æ­¢æ‰‹æœºæ»‘è½ï¼Œè§£æ”¾åŒæ‰‹ã€‚"
                      data-img-src="æ–‡åˆ›äº§å“/0918_01_æ‰‹æœºæŒ‚ç»³(1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_æ‰‹æœºæŒ‚ç»³(1).jpg" alt="é€šé€šæ‰‹æœºæŒ‚ç»³" onerror="this.alt='æ‰‹æœºæŒ‚ç»³å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=æ‰‹æœºæŒ‚ç»³';">
                    <h3>é€šé€šæ‰‹æœºæŒ‚ç»³</h3>
                    <p class="product-item-short-desc">å®ç”¨é€šé€šæ‰‹æœºæŒ‚ç»³ï¼Œè§£æ”¾åŒæ‰‹ï¼Œæ—¶å°šä¾¿æ·ã€‚</p>
                    <p class="static-description">è¿™æ˜¯ä¸€æ¬¾å®ç”¨åˆæ—¶å°šçš„é€šé€šä¸»é¢˜æ‰‹æœºæŒ‚ç»³ã€‚æŒ‚ç»³ä¸»ä½“ä¸ºçº¢ç™½ç›¸é—´çš„ç¼–ç»‡ç»³ï¼Œä¸Šé¢å°æœ‰è¿ç»­çš„é€šé€šå¤´åƒå›¾æ¡ˆã€‚è¿æ¥æ‰‹æœºçš„éƒ¨åˆ†æœ‰ä¸€ä¸ªå¯çˆ±çš„é€šé€šå…¬ä»”å¤´åƒä½œä¸ºè£…é¥°å’Œå›ºå®šæ‰£ï¼Œé€ å‹èŒè¶£ã€‚å¯ä»¥æœ‰æ•ˆé˜²æ­¢æ‰‹æœºæ»‘è½ï¼Œè§£æ”¾åŒæ‰‹ã€‚</p>
                    <p class="product-item-price">Â¥25</p>
                </div>
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥35" data-name="é€šé€šåŸºç«™å¾½ç« " 
                     data-description="è¿™æ˜¯ä¸€å¥—é€šé€šæ¼«æ¸¸åŸå¸‚ç³»åˆ—å¾½ç« ï¼Œå…±å››æšï¼Œè£…åœ¨ä¸€ä¸ªæ©™è‰²çš„ç¤¼ç›’ä¸­ã€‚æ¯æšå¾½ç« éƒ½å‘ˆç°äº†é€šé€šå‰ç¥¥ç‰©ä¸ä¸­å›½ä¸åŒåŸå¸‚åœ°æ ‡çš„ç»„åˆï¼Œä¾‹å¦‚é€šé€šä¸åŒ—äº¬å¤©å›ã€é€šé€šä¸ä¸Šæµ·ä¸œæ–¹æ˜ç ã€é€šé€šä¸å¹¿å·å¡”ä»¥åŠé€šé€šä¸æˆéƒ½å¤§ç†ŠçŒ«ã€‚å¾½ç« é€ å‹å„å¼‚ï¼Œè‰²å½©é²œè‰³ï¼Œåˆ¶ä½œç²¾ç¾ï¼Œå¯Œæœ‰çºªå¿µæ„ä¹‰ã€‚"
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_å››æ–¹åŸºç«™å¾½ç« (1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_å››æ–¹åŸºç«™å¾½ç« (1).jpg" alt="é€šé€šåŸºç«™å¾½ç« " onerror="this.alt='åŸºç«™å¾½ç« å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=åŸºç«™å¾½ç« ';">
                    <h3>é€šé€šåŸºç«™å¾½ç« </h3>
                    <p class="product-item-short-desc">åˆ›æ„å››æ–¹åŸºç«™å¾½ç« ï¼Œè”é€šç²¾ç¥ï¼Œéšèº«ä½©æˆ´ã€‚</p>
                    <p class="static-description">è¿™æ˜¯ä¸€å¥—é€šé€šæ¼«æ¸¸åŸå¸‚ç³»åˆ—å¾½ç« ï¼Œå…±å››æšï¼Œè£…åœ¨ä¸€ä¸ªæ©™è‰²çš„ç¤¼ç›’ä¸­ã€‚æ¯æšå¾½ç« éƒ½å‘ˆç°äº†é€šé€šå‰ç¥¥ç‰©ä¸ä¸­å›½ä¸åŒåŸå¸‚åœ°æ ‡çš„ç»„åˆï¼Œä¾‹å¦‚é€šé€šä¸åŒ—äº¬å¤©å›ã€é€šé€šä¸ä¸Šæµ·ä¸œæ–¹æ˜ç ã€é€šé€šä¸å¹¿å·å¡”ä»¥åŠé€šé€šä¸æˆéƒ½å¤§ç†ŠçŒ«ã€‚å¾½ç« é€ å‹å„å¼‚ï¼Œè‰²å½©é²œè‰³ï¼Œåˆ¶ä½œç²¾ç¾ï¼Œå¯Œæœ‰çºªå¿µæ„ä¹‰ã€‚</p>
                    <p class="product-item-price">Â¥35</p>
                </div>
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥19" data-name="é€šé€šé¦™å¡" 
                     data-description="è¿™æ˜¯ä¸€æ¬¾é€šé€šä¸»é¢˜çš„é¦™å¡ã€‚å¡ç‰‡ä¸»ä½“ä¸ºæ©™è‰²è°ƒï¼Œå°æœ‰å¯çˆ±çš„é€šé€šå½¢è±¡ï¼ŒèƒŒæ™¯æ˜¯æŠ½è±¡çš„å½©è‰²èƒ½é‡æµçº¿æ¡ï¼Œå……æ»¡åŠ¨æ„Ÿã€‚å¡ç‰‡ä¸Šå°æœ‰'é€šé€šé¦™å¡'å­—æ ·ï¼Œå¹¶æ³¨æ˜å¯ç”¨äºè½¦å†…ã€è¡£æŸœã€æˆ¿é—´æ‰©é¦™ã€‚è®¾è®¡æ¸…æ–°æ´»æ³¼ï¼Œèƒ½å¸¦æ¥æ„‰æ‚¦çš„é¦™æ°”ä½“éªŒã€‚"
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_é¦™å¡(1).jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_é¦™å¡(1).jpg" alt="é€šé€šé¦™å¡" onerror="this.alt='é¦™å¡å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=é¦™å¡';">
                    <h3>é€šé€šé¦™å¡</h3>
                    <p class="product-item-short-desc">æ¸…æ–°é€šé€šä¸»é¢˜é¦™å¡ï¼Œæ€¡äººé¦™æ°”ï¼Œç‚¹ç¼€ç©ºé—´ã€‚</p>
                    <p class="static-description">è¿™æ˜¯ä¸€æ¬¾é€šé€šä¸»é¢˜çš„é¦™å¡ã€‚å¡ç‰‡ä¸»ä½“ä¸ºæ©™è‰²è°ƒï¼Œå°æœ‰å¯çˆ±çš„é€šé€šå½¢è±¡ï¼ŒèƒŒæ™¯æ˜¯æŠ½è±¡çš„å½©è‰²èƒ½é‡æµçº¿æ¡ï¼Œå……æ»¡åŠ¨æ„Ÿã€‚å¡ç‰‡ä¸Šå°æœ‰'é€šé€šé¦™å¡'å­—æ ·ï¼Œå¹¶æ³¨æ˜å¯ç”¨äºè½¦å†…ã€è¡£æŸœã€æˆ¿é—´æ‰©é¦™ã€‚è®¾è®¡æ¸…æ–°æ´»æ³¼ï¼Œèƒ½å¸¦æ¥æ„‰æ‚¦çš„é¦™æ°”ä½“éªŒã€‚</p>
                    <p class="product-item-price">Â¥19</p>
                </div>
                <div class="product-item" onclick="showProductDetail(this)" data-price="Â¥39" data-name="é€šé€šæ—‹è½¬é’¥åŒ™æ‰£" 
                     data-description="è¿™æ¬¾æ˜¯è®¾è®¡ç‹¬ç‰¹çš„é€šé€šæ—‹è½¬å¹¸è¿é’¥åŒ™æ‰£ã€‚é’¥åŒ™æ‰£å¤–åœˆä¸ºçº¢è‰²ï¼Œé¥°æœ‰ç²¾ç¾çš„é‡‘è‰²ä¼ ç»Ÿå›çº¹å›¾æ¡ˆå’Œä¸€åœˆé—ªäº®çš„ä»¿æ°´é’»ã€‚ä¸­å¤®éƒ¨åˆ†æ˜¯ä¸€ä¸ªå¯ä»¥360åº¦æ—‹è½¬çš„é‡‘è‰²é€šé€šå°å…¬ä»”ï¼Œé€ å‹æ´»æ³¼å¯çˆ±ã€‚æ•´ä½“å·¥è‰ºç²¾è‡´ï¼Œå¯“æ„å‰ç¥¥ï¼Œå…¼å…·è¶£å‘³æ€§å’Œè£…é¥°æ€§ã€‚"
                     data-img-src="æ–‡åˆ›äº§å“/0918_01_æ—‹è½¬æ¬¾é’¥åŒ™æ‰£.jpg">
                    <img src="æ–‡åˆ›äº§å“/0918_01_æ—‹è½¬æ¬¾é’¥åŒ™æ‰£.jpg" alt="é€šé€šæ—‹è½¬é’¥åŒ™æ‰£" onerror="this.alt='æ—‹è½¬é’¥åŒ™æ‰£å›¾ç‰‡'; this.src='https://placehold.co/300x200/E0E0E0/333333?text=æ—‹è½¬é’¥åŒ™æ‰£';">
                    <h3>é€šé€šæ—‹è½¬é’¥åŒ™æ‰£</h3>
                    <p class="product-item-short-desc">ç‹¬ç‰¹æ—‹è½¬è®¾è®¡é’¥åŒ™æ‰£ï¼Œè¶£å‘³åè¶³ï¼Œä¸ªæ€§é€‰æ‹©ã€‚</p>
                    <p class="static-description">è¿™æ¬¾æ˜¯è®¾è®¡ç‹¬ç‰¹çš„é€šé€šæ—‹è½¬å¹¸è¿é’¥åŒ™æ‰£ã€‚é’¥åŒ™æ‰£å¤–åœˆä¸ºçº¢è‰²ï¼Œé¥°æœ‰ç²¾ç¾çš„é‡‘è‰²ä¼ ç»Ÿå›çº¹å›¾æ¡ˆå’Œä¸€åœˆé—ªäº®çš„ä»¿æ°´é’»ã€‚ä¸­å¤®éƒ¨åˆ†æ˜¯ä¸€ä¸ªå¯ä»¥360åº¦æ—‹è½¬çš„é‡‘è‰²é€šé€šå°å…¬ä»”ï¼Œé€ å‹æ´»æ³¼å¯çˆ±ã€‚æ•´ä½“å·¥è‰ºç²¾è‡´ï¼Œå¯“æ„å‰ç¥¥ï¼Œå…¼å…·è¶£å‘³æ€§å’Œè£…é¥°æ€§ã€‚</p>
                    <p class="product-item-price">Â¥39</p>
                </div>
            </div>
        </div>
        <button onclick="navigateTo('section-draw')" class="button-primary mt-8">å‚ä¸å¹¸è¿æŠ½å¥–</button>
    </section>

    <section id="section-draw" class="section bg-yellow-100">
        <h2 class="text-3xl font-bold text-yellow-700 mb-6">å¹¸è¿å¤§æŠ½å¥–</h2>
        <img src="lihe.png" alt="æŠ½å¥–ç¤¼ç›’" class="w-40 h-40 md:w-48 md:h-48 rounded-lg shadow-lg mb-8" onerror="this.alt='ç¤¼ç›’å›¾ç‰‡'; this.style.backgroundColor='#ccc';">
        <p id="draw-result" class="text-xl text-gray-700 mb-8">ç‚¹å‡»æŒ‰é’®ï¼ŒæŠ½å–ä½ çš„ä¸“å±å¹¸è¿ï¼</p>
        <button id="draw-button" onclick="performDraw()" class="button-primary bg-yellow-500 hover:bg-yellow-600 text-lg">ç«‹å³æŠ½å¥–</button>
        <button onclick="navigateTo('section-cta')" class="button-primary mt-8">äº†è§£æ›´å¤š</button>
    </section>

    <section id="section-maze" class="section bg-purple-100">
        <h2 class="text-3xl font-bold text-purple-700 mb-6">é€šé€šé—¯è¿·å®«</h2>

        <div class="w-[300px] mx-auto relative mb-2"> 
            <div id="maze-game-music-toggle" class="music-toggle-button absolute top-[40px] right-0 z-10">
                <img src="music_on.png" alt="Music On" onerror="this.parentElement.innerHTML = '<span style=\'font-size:12px;\'>ğŸµOn</span>';">
            </div>
        </div>
        
        <p class="text-lg text-gray-700 mb-2">å¸®åŠ©é€šé€šæ‰¾åˆ°ä¸­å›½ç»“ï¼(ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®)</p>
        <p class="game-timer-info">ç”¨æ—¶: <span id="maze-time-display">0</span> ç§’</p>
        <div class="maze-canvas-wrapper">
            <canvas id="mazeCanvas" width="300" height="300"></canvas>
        </div>

        <div id="maze-game-controls" class="mt-4 md:mt-4">
            <button id="start-maze-btn" onclick="startMazeGame()" class="button-primary bg-purple-600 hover:bg-purple-700 text-lg">å¼€å§‹æ¸¸æˆ</button>
            <button id="maze-to-products-btn" onclick="navigateTo('section-products')" class="button-primary bg-purple-600 hover:bg-purple-700 mt-0 ml-2 text-lg" style="display:none;">æŸ¥çœ‹æ–‡åˆ›äº§å“</button>
        </div>

        <div id="maze-controls-mobile" class="mt-3 grid grid-cols-3 gap-2 justify-items-center items-center w-max mx-auto md:hidden" style="width: calc(60px * 3 + 0.5rem * 2);">
            <div></div> <button class="maze-arrow-button" data-direction="up" aria-label="å‘ä¸Šç§»åŠ¨">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19.5v-15m0 0l-6.75 6.75M12 4.5l6.75 6.75" /></svg>
            </button>
            <div></div> <button class="maze-arrow-button" data-direction="left" aria-label="å‘å·¦ç§»åŠ¨">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15m0 0l6.75 6.75M4.5 12l6.75-6.75" /></svg>
            </button>
            <div class="w-[60px] h-[60px]"></div> <button class="maze-arrow-button" data-direction="right" aria-label="å‘å³ç§»åŠ¨">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /></svg>
            </button>
            <div></div> <button class="maze-arrow-button" data-direction="down" aria-label="å‘ä¸‹ç§»åŠ¨">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m0 0l6.75-6.75M12 19.5l-6.75-6.75" /></svg>
            </button>
            <div></div> </div>
    </section>

    <section id="section-match-game" class="section bg-green-100">
        <h1>é€šé€šæ–‡åˆ›æ¶ˆæ¶ˆä¹</h1>
        <div class="desc">ç‚¹å‡»äº¤æ¢ç›¸é‚»çš„æ–‡åˆ›äº§å“å›¾ç‰‡ï¼Œä¸‰ä¸ªåŠä»¥ä¸Šç›¸åŒå³å¯æ¶ˆé™¤ï¼Œå¿«æ¥ä½“éªŒæ–‡åˆ›é­…åŠ›å§ï¼</div>

        <div class="stats-container">
            <div id="score">åˆ†æ•°ï¼š0</div>
            <div id="timer">å‰©ä½™æ—¶é—´ï¼š60ç§’</div>
            <div id="hint-count-display">æç¤ºï¼š2æ¬¡</div>
            <div id="match-game-music-toggle" class="music-toggle-button">
                <img src="music_on.png" alt="Music On" onerror="this.parentElement.innerHTML = '<span style=\'font-size:12px;\'>ğŸµOn</span>';">
            </div>
        </div>

        <div class="controls">
            <button id="action-btn" class="game-button">å¼€å§‹æ¸¸æˆ</button>
            <button id="hint-btn" class="game-button">æç¤º</button>
            <button id="match-game-to-products-btn" style="display:none;">æŸ¥çœ‹æ–‡åˆ›äº§å“</button>
        </div>

        <div id="game-board">
            </div>

        <div class="message-box-overlay" id="message-box-overlay">
            <div class="message-box">
                <p id="message-box-text"></p>
                <button id="message-box-ok">å¥½</button>
            </div>
        </div>
    </section>


    <section id="section-cta" class="section bg-green-100">
        <h2 class="text-3xl font-bold text-green-700 mb-6">æ„Ÿè°¢å‚ä¸ï¼</h2>
        <img src="liantong.png" alt="æ„Ÿè°¢é€šé€š" class="w-auto h-20 rounded-lg shadow-lg mb-8" onerror="this.alt='è”é€šLogo'; this.style.backgroundColor='#ccc';">
        <p class="text-lg text-gray-700 mb-8">å…³æ³¨ä¸­å›½è”é€šï¼Œè·å–æ›´å¤šç²¾ç¾æ–‡åˆ›èµ„è®¯å’Œä¼˜æƒ æ´»åŠ¨ï¼</p>
        <a href="https://m.10010.com/scaffold-show/subject/99p8r185qFL?isSupportPc=true" target="_blank" class="button-primary bg-green-500 hover:bg-green-600 text-lg mb-4">è®¿é—®å®˜æ–¹å•†åŸ</a>
        <button onclick="showQrCodeModal()" class="button-primary bg-blue-500 hover:bg-blue-600 text-lg">å…³æ³¨æˆ‘ä»¬</button>
        <button onclick="navigateTo('section-welcome')" class="button-primary bg-gray-500 hover:bg-gray-600 mt-8">é‡æ–°å¼€å§‹</button>
    </section>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" onclick="this.parentElement.parentElement.style.display='none'; updateBackButtonVisibility();">&times;</button>
            <h3 id="modalTitle">æç¤º</h3>
            <p id="modalMessage">è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯ã€‚</p>
            <button id="modalCloseButton" class="button-primary">çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="productDetailModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeProductDetailModal()">&times;</button>
            <img id="productDetailImage" src="" alt="äº§å“å›¾ç‰‡" class="mb-4" onerror="this.src='https://placehold.co/400x300/F0F0F0/AAAAAA?text=äº§å“å›¾ç‰‡åŠ è½½å¤±è´¥'; this.alt='äº§å“å›¾ç‰‡å ä½å›¾';">
            <h3 id="productDetailName" class="text-2xl font-bold text-orange-600 mb-2">äº§å“åç§°</h3>
            
            <div id="ai-description-loader" class="text-sm text-gray-500 my-2" style="display: none;">âœ¨ é€šé€šæ­£åœ¨ä¸ºäº§å“ç”Ÿæˆæ›´ç”ŸåŠ¨æè¿°...</div>
            <p id="productDetailDescription" class="text-gray-700 mb-3"></p> 
            
            <p id="productDetailPrice" class="text-xl font-semibold text-orange-700 mb-6">ä»·æ ¼</p>
            <button id="productDetailBuyButton" class="button-primary w-full">ç«‹å³è´­ä¹°</button>
        </div>
    </div>

    <div id="qrCodeModal" class="modal">
        <div class="modal-content flex flex-col items-center">
            <h3 id="qrCodeModalTitle" class="text-xl font-semibold text-blue-600 mb-4">æ„Ÿè°¢æ‚¨å…³æ³¨ä¸­å›½è”é€šå®˜æ–¹å¾®ä¿¡å…¬ä¼—å·ï¼</h3>
            <img id="qrCodeImage" src="gzh.jpg" alt="å…³æ³¨æˆ‘ä»¬äºŒç»´ç " onerror="this.alt='äºŒç»´ç å›¾ç‰‡'; this.src='https://placehold.co/280x280/EEEEEE/333333?text=äºŒç»´ç ';">
            <button onclick="closeQrCodeModal()" class="button-primary bg-blue-500 hover:bg-blue-600 mt-4">å…³é—­</button>
        </div>
    </div>


    <script>
        // --- Global State and Configuration ---
        let currentSection = 'section-welcome'; 
        let navigationHistory = []; 
        let clickerGameCompletedOnce = false; 
        let mazeGameWonOnce = false; 
        window.matchGameInitialized = false; 
        window.matchGameContext = {
            isMatchGameMusicOn: true, 
            hasEverCompletedMatchGame: false, 
            matchGameCompletedOnce: false 
        };

        // --- DOM Element References ---
        const hotspotPopup = document.getElementById('hotspot-popup');
        const hotspotTitle = document.getElementById('hotspot-title');
        const hotspotText = document.getElementById('hotspot-text');
        const messageModal = document.getElementById('messageModal');
        const modalTitleElem = document.getElementById('modalTitle');
        const modalMessageElem = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const qrCodeModal = document.getElementById('qrCodeModal');
        const productDetailModal = document.getElementById('productDetailModal');
        const productDetailImage = document.getElementById('productDetailImage');
        const productDetailName = document.getElementById('productDetailName');
        const productDetailDescription = document.getElementById('productDetailDescription');
        const productDetailPrice = document.getElementById('productDetailPrice');
        const productDetailBuyButton = document.getElementById('productDetailBuyButton');
        const aiDescriptionLoader = document.getElementById('ai-description-loader'); 
        const enhanceHotspotBtn = document.getElementById('enhance-hotspot-btn');
        const aiHotspotContent = document.getElementById('ai-hotspot-content');
        const aiHotspotLoading = document.getElementById('ai-hotspot-loading');
        const tongtongChatModalContainer = document.getElementById('tongtong-chat-modal-container');
        const chatHistoryModalEl = document.getElementById('chat-history-modal');
        const chatInputModalEl = document.getElementById('chat-input-modal');
        const sendChatModalBtn = document.getElementById('send-chat-modal-btn');
        const closeChatModalBtn = document.getElementById('close-chat-modal-btn');
        const chatLoadingModalEl = document.getElementById('chat-loading-modal');
        const tongtongChatHistory = []; 
        const tongtongChatToggleButton = document.getElementById('tongtong-chat-toggle-button');

        // Fallback descriptions for products if AI generation fails
        const finalFallbackProductDescriptions = {
            "é€šé€šä¿æ¸©æ¯": "è¿™æ¬¾é€šé€šä¸»é¢˜ä¿æ¸©æ¯ï¼Œé‡‡ç”¨ä¼˜è´¨ä¸é”ˆé’¢ææ–™ï¼Œé•¿æ•ˆä¿æ¸©ä¿å†·ã€‚æ¯èº«å°æœ‰å¯çˆ±çš„é€šé€šå½¢è±¡å’ŒåŸå¸‚å‰ªå½±ï¼Œæ—¶å°šåˆå®ç”¨ã€‚æ— è®ºæ˜¯çƒ­èŒ¶è¿˜æ˜¯å†°é¥®ï¼Œå®ƒéƒ½èƒ½é”ä½æ¸©åº¦ï¼Œè®©ä½ éšæ—¶ç•…é¥®ã€‚å¸¦ä¸Šå®ƒï¼Œè®©é€šé€šçš„æ¸©æš–é™ªä¼´ä½ çš„æ¯ä¸€å¤©ï¼",
            "é€šé€šå……ç”µçº¿": "é€šé€šä¸‰åˆä¸€å¿«é€Ÿå……ç”µçº¿ï¼ŒèŒè¶£çš„é€šé€šå…¬ä»”å¤´è®¾è®¡ï¼Œä¸ä»…å¯çˆ±è¿˜èƒ½ä¿æŠ¤æ¥å£ã€‚ä¸€çº¿å¤šç”¨ï¼Œå…¼å®¹è‹¹æœã€å®‰å“ã€Type-Cè®¾å¤‡ï¼Œæ»¡è¶³ä½ çš„å¤šç§å……ç”µéœ€æ±‚ã€‚ä¼˜è´¨ç¼–ç»‡çº¿èº«ï¼Œè€ç”¨é˜²ç¼ ç»•ã€‚è®©é€šé€šä¸ºä½ æ³¨å…¥æ»¡æ»¡ç”µåŠ›ï¼Œå‘Šåˆ«ç”µé‡ç„¦è™‘ï¼",
            "é€šé€šåœ°çƒé’¥åŒ™æ‰£": "é€šé€šåœ°çƒæ¢ç´¢é’¥åŒ™æ‰£ï¼Œä»¥æ—‹è½¬çš„åœ°çƒå’Œæ‰‹æŒç¬”è®°æœ¬ç”µè„‘çš„é€šé€šä¸ºè®¾è®¡å…ƒç´ ï¼Œé•¶åµŒé—ªäº®æ°´é’»ï¼Œå¯“æ„è”é€šä¸–ç•Œã€è¿æ¥æœªæ¥ã€‚é‡‘å±è´¨æ„Ÿï¼Œç²¾è‡´è€ç”¨ï¼Œä¸ä»…æ˜¯é’¥åŒ™çš„å¥½ä¼´ä¾£ï¼Œä¹Ÿæ˜¯åŒ…åŒ…è£…é¥°çš„äº®ç‚¹ã€‚è®©é€šé€šå¸¦ä½ ç¯æ¸¸ä¸–ç•Œï¼Œæ¢ç´¢æ— é™å¯èƒ½ï¼",
            "é€šé€šæ¯›ç»’ç©å…·": "è¶…èŒçš„é€šé€šå‰ç¥¥ç‰©æ¯›ç»’å…¬ä»”æ¥å•¦ï¼é‡‡ç”¨äº²è‚¤æŸ”è½¯çŸ­æ¯›ç»’ï¼Œå¡«å……é¥±æ»¡Qå¼¹ï¼Œæ‰‹æ„Ÿè¶…èˆ’é€‚ã€‚ç»å…¸çš„é€šé€šé€ å‹ï¼Œå¤§çœ¼ç›å’Œæ ‡å¿—æ€§çš„è§¦è§’ï¼Œå¯çˆ±åˆ°çŠ¯è§„ï¼æ— è®ºæ˜¯æŠ±åœ¨æ€€é‡Œè¿˜æ˜¯ä½œä¸ºæ‘†ä»¶ï¼Œéƒ½èƒ½ç»™ä½ å¸¦æ¥å¥½å¿ƒæƒ…ã€‚å¿«æŠŠå¯çˆ±çš„é€šé€šå¸¦å›å®¶å§ï¼",
            "é‡‘è‰²é€šé€šæ‰‹åŠ": "é™é‡çè—ç‰ˆé‡‘è‰²é€šé€šæ‰‹åŠï¼Œé—ªè€€çš„é‡‘è‰²æ¶‚è£…ï¼Œè®©é€šé€šæ›´æ˜¾å°Šè´µä¸æ´»åŠ›ã€‚é€ å‹ç”ŸåŠ¨ï¼Œç»†èŠ‚ç²¾è‡´ï¼Œåº•åº§ç¨³å›ºï¼Œæ˜¯æ¡Œé¢ä¸Šä¸€é“äº®ä¸½çš„é£æ™¯çº¿ã€‚ä¸ä»…æ˜¯è”é€šç²‰ä¸çš„å¿…å¤‡æ”¶è—ï¼Œä¹Ÿæ˜¯ä¸€ä»½å……æ»¡å¿ƒæ„å’Œç§‘æŠ€æ„Ÿçš„ç‹¬ç‰¹å¥½ç¤¼ã€‚",
            "é€šé€šæ‰‹æœºæŒ‚ç»³": "é€šé€šå®šåˆ¶æ¬¾æ‰‹æœºæŒ‚ç»³ï¼Œå®½ç‰ˆè®¾è®¡èˆ’é€‚ä¸å‹’æ‰‹ï¼Œå°æœ‰å¯çˆ±çš„é€šé€šå›¾æ¡ˆåºåˆ—ã€‚æ­é…èŒè¶£çš„é€šé€šå…¬ä»”å¤´å›ºå®šæ‰£ï¼Œæ—¢å®ç”¨åˆæ—¶å°šã€‚è§£æ”¾ä½ çš„åŒæ‰‹ï¼Œè®©æ‰‹æœºéšèº«æºå¸¦æ›´å®‰å…¨ä¾¿æ·ã€‚å¤šç§ç”¨æ³•ï¼Œå¯æŒ‚æ‰‹æœºã€å·¥ç‰Œã€é’¥åŒ™ç­‰ã€‚",
            "é€šé€šåŸºç«™å¾½ç« ": "é€šé€šæ¼«æ¸¸åŸå¸‚ç³»åˆ—å¾½ç« å¥—è£…ï¼Œä¸€å¥—å››æšï¼Œåˆ†åˆ«å±•ç°äº†é€šé€šåœ¨ä¸åŒåŸå¸‚åœ°æ ‡ï¼ˆå¦‚åŒ—äº¬å¤©å›ã€ä¸Šæµ·ä¸œæ–¹æ˜ç ã€å¹¿å·å¡”ã€æˆéƒ½å¤§ç†ŠçŒ«åŸºåœ°ï¼‰çš„å¯çˆ±å½¢è±¡ã€‚è®¾è®¡ç²¾å·§ï¼Œè‰²å½©é²œæ˜ï¼Œæ˜¯æ”¶è—å’Œä½©æˆ´çš„ä½³å“ï¼Œè±¡å¾ç€è”é€šä¿¡å·è¦†ç›–ç¥å·å¤§åœ°ã€‚",
            "é€šé€šé¦™å¡": "é€šé€šä¸»é¢˜å®šåˆ¶é¦™å¡ï¼Œæ•£å‘æŒä¹…æ·¡é›…æ¸…é¦™ã€‚å¯çˆ±çš„é€šé€šå½¢è±¡æ­é…ç¼¤çº·çš„å½©è™¹å…ƒç´ ï¼Œä¸ºä½ å¸¦æ¥è§†è§‰ä¸å—…è§‰çš„åŒé‡æ„‰æ‚¦ã€‚é€‚ç”¨äºè½¦å†…ã€è¡£æŸœã€æˆ¿é—´ç­‰å¤šç§åœºæ™¯ï¼Œè½»æ¾å»é™¤å¼‚å‘³ï¼Œè¥é€ æ¸…æ–°èˆ’é€‚çš„æ°›å›´ã€‚è®©é€šé€šçš„èŠ¬èŠ³ä¼´ä½ å·¦å³ã€‚",
            "é€šé€šæ—‹è½¬é’¥åŒ™æ‰£": "é€šé€šå¹¸è¿è½¬è½¬é’¥åŒ™æ‰£ï¼Œå¤–åœˆé‡‡ç”¨ä¸­å›½ä¼ ç»Ÿå›çº¹é•‚ç©ºè®¾è®¡ï¼Œé•¶åµŒé—ªäº®æ°´é’»ï¼Œä¸­é—´æ˜¯å¯çˆ±çš„é‡‘è‰²é€šé€šå…¬ä»”ï¼Œå¯ä»¥è‡ªç”±æ—‹è½¬ã€‚å¯“æ„æ—¶æ¥è¿è½¬ï¼Œå¥½è¿è¿è¿ã€‚é‡‘å±æè´¨ï¼Œå·¥è‰ºç²¾æ¹›ï¼Œæ˜¯é’¥åŒ™æ‰£ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰è¶£çš„æŒä¸Šå°ç©å…·ã€‚"
        };


        // --- Modal Functionality ---
        if (modalCloseButton) {
            modalCloseButton.onclick = () => {
                if (messageModal) messageModal.style.display = 'none';
                updateBackButtonVisibility(); 
            };
        }

        function showMessage(title, message) {
            if (modalTitleElem) modalTitleElem.textContent = title;
            if (modalMessageElem) modalMessageElem.textContent = message;
            if (messageModal) messageModal.style.display = 'flex'; 
            updateBackButtonVisibility(); 
        }

        // --- DeepSeek API Integration ---
        async function callDeepSeekAPI(prompt, isChat = false) {
            let deepSeekMessages = [];
            const systemMessageContent = "ä½ æ˜¯ä¸­å›½è”é€šçš„å‰ç¥¥ç‰©â€œé€šé€šâ€ï¼Œä¸€ä¸ªå‹å¥½ã€ä¹äºåŠ©äººçš„äººå·¥æ™ºèƒ½åŠ©æ‰‹ã€‚"; 

            if (isChat) {
                deepSeekMessages = tongtongChatHistory.map(msg => ({
                    role: msg.role === 'model' ? 'assistant' : msg.role, 
                    content: msg.parts[0].text 
                }));
                deepSeekMessages.push({ role: "user", content: prompt });
            } else {
                deepSeekMessages.push({ role: "system", content: systemMessageContent });
                deepSeekMessages.push({ role: "user", content: prompt });
            }

            if (deepSeekMessages.length === 0 || deepSeekMessages[0].role !== 'system') {
                deepSeekMessages.unshift({ role: "system", content: systemMessageContent });
            }

            const payload = {
                model: "deepseek-chat", 
                messages: deepSeekMessages,
                stream: false 
            };

            const apiKey = "sk-49d0e05218fd4ed0b25384aa6847478a"; 
            const apiUrl = "https://api.deepseek.com/chat/completions"; 

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` 
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("DeepSeek API Error:", errorData);
                    const message = errorData.error && errorData.error.message ? errorData.error.message : `APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`;
                    if (isChat && !navigator.onLine) {
                        return { error: "è¯·è”ç½‘åå†ä¸é€šé€šèŠå¤©" };
                    }
                    return { error: `AIå†…å®¹ç”Ÿæˆå¤±è´¥ï¼š${message}` };
                }

                const result = await response.json();

                if (result.choices && result.choices.length > 0 && result.choices[0].message && result.choices[0].message.content) {
                    const generatedText = result.choices[0].message.content;
                    if (isChat) {
                        tongtongChatHistory.push({ role: "model", parts: [{ text: generatedText }] });
                    }
                    return { text: generatedText };
                } else {
                    console.error("Unexpected response structure from DeepSeek API:", result);
                    if (isChat && !navigator.onLine) {
                         return { error: "è¯·è”ç½‘åå†ä¸é€šé€šèŠå¤©" };
                    }
                    return { error: "AIæœªèƒ½ç”Ÿæˆå†…å®¹ï¼Œè¯·ç¨åå†è¯•ã€‚" };
                }
            } catch (error) {
                console.error("Error calling DeepSeek API:", error);
                if (isChat && !navigator.onLine) {
                    return { error: "è¯·è”ç½‘åå†ä¸é€šé€šèŠå¤©" };
                }
                return { error: "è°ƒç”¨AIæœåŠ¡æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚" };
            }
        }

        async function getAIEnhancedHotspotInfo(title, originalText) {
            if (aiHotspotContent) aiHotspotContent.innerHTML = ''; 
            if (aiHotspotLoading) aiHotspotLoading.style.display = 'block'; 
            const prompt = `ä½ æ˜¯ä¸€ä¸ªæ´»æ³¼å¯çˆ±çš„å‰ç¥¥ç‰©â€œé€šé€šâ€çš„ä¼™ä¼´ã€‚è¯·ç”¨ç”ŸåŠ¨æœ‰è¶£çš„æ–¹å¼ï¼Œè¯¦ç»†è§£è¯»ä¸€ä¸‹â€œé€šé€šâ€çš„'${title}'è¿™ä¸ªéƒ¨åˆ†ï¼Œå®ƒè±¡å¾ç€ï¼š'${originalText}'ã€‚è¯·ç”¨å¤§çº¦50-100å­—å±•å¼€æè¿°ï¼Œè®©å°æœ‹å‹å’Œå®¶é•¿éƒ½å–œæ¬¢ã€‚`;
            const result = await callDeepSeekAPI(prompt); 
            if (aiHotspotLoading) aiHotspotLoading.style.display = 'none'; 
            if (aiHotspotContent) {
                if (result.error) {
                    aiHotspotContent.innerHTML = `<p class="text-red-500">${result.error}</p>`; 
                } else {
                    aiHotspotContent.innerHTML = `<p class="text-sm text-gray-700 mt-2 p-3 bg-orange-50 rounded-lg shadow-inner border border-orange-200">${result.text.replace(/\n/g, '<br>')}</p>`;
                }
            }
        }

        async function getAIEnhancedProductDescription(productNameKey, imageBasedDesc, descriptionElement, loadingElement, finalFallbackText) {
            const prompt = `ä½ æ˜¯ä¸€ä½ä¼˜ç§€çš„è”é€šæ–‡åˆ›äº§å“è¥é”€ä¸“å®¶ã€‚è¿™é‡Œæœ‰ä¸€æ¬¾äº§å“å«åšâ€œ${productNameKey}â€ã€‚å…³äºè¿™æ¬¾äº§å“çš„å¤–è§‚å’Œç‰¹ç‚¹ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€æ®µåŸºäºå›¾ç‰‡çš„è¯¦ç»†æè¿°ï¼šâ€œ${imageBasedDesc}â€ã€‚è¯·ä½ åŸºäºè¿™æ®µè¯¦ç»†æè¿°ï¼Œç”¨æ›´åŠ ç”ŸåŠ¨ã€å¯Œæœ‰å¸å¼•åŠ›ä¸”ç•¥å¸¦è¶£å‘³æ€§çš„è¯­è¨€ï¼Œè¿›ä¸€æ­¥æ¶¦è‰²å’Œåˆ›ä½œä¸€æ®µå¤§çº¦50-100å­—çš„æ¨å¹¿æ–‡æ¡ˆï¼Œçªå‡ºäº§å“çš„äº®ç‚¹å’Œå¸¦ç»™ç”¨æˆ·çš„ç¾å¥½ä½“éªŒï¼Œè®©äººä¸€å¬å°±æƒ³æ‹¥æœ‰å®ƒã€‚è¯·ç›´æ¥è¾“å‡ºæœ€ç»ˆçš„æ¨å¹¿æ–‡æ¡ˆï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæ€§æ–‡å­—æˆ–å¼€åœºç™½ï¼Œä¹Ÿä¸è¦é‡å¤â€œ${imageBasedDesc}â€ä¸­çš„åŸå¥ã€‚`;
            
            const result = await callDeepSeekAPI(prompt); 

            if (loadingElement) loadingElement.style.display = 'none'; 

            if (descriptionElement) {
                if (result.error) {
                    descriptionElement.innerHTML = finalFallbackText.replace(/\n/g, '<br>');
                } else {
                    descriptionElement.innerHTML = result.text.replace(/\n/g, '<br>');
                }
            }
        }

        // --- Chat Modal Functionality ---
        function addMessageToChatModalUI(message, sender) {
            if (!chatHistoryModalEl) return; 
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message-modal'); 

            if (sender === 'user') {
                messageDiv.classList.add('user-message-modal'); 
                messageDiv.innerHTML = message.replace(/\n/g, '<br>'); 
            } else { 
                messageDiv.classList.add('ai-message-modal'); 
                const avatarImg = document.createElement('img');
                avatarImg.src = 'xia.png'; 
                avatarImg.alt = 'é€šé€šå¤´åƒ';
                avatarImg.classList.add('chat-avatar');
                avatarImg.onerror = function() { this.style.display='none'; }; 
                messageDiv.appendChild(avatarImg);
                const textSpan = document.createElement('span');
                textSpan.classList.add('message-text-modal');
                textSpan.innerHTML = message.replace(/\n/g, '<br>');
                messageDiv.appendChild(textSpan);
            }
            
            chatHistoryModalEl.appendChild(messageDiv); 
            chatHistoryModalEl.scrollTop = chatHistoryModalEl.scrollHeight; 
        }

        async function handleSendChatModalMessage() {
            if (!chatInputModalEl || !sendChatModalBtn || !chatLoadingModalEl) return;
            const userQuery = chatInputModalEl.value.trim();
            if (!userQuery) return; 

            addMessageToChatModalUI(userQuery, 'user'); 
            chatInputModalEl.value = ''; 
            chatLoadingModalEl.style.display = 'block'; 
            sendChatModalBtn.disabled = true; 
            
            let result = await callDeepSeekAPI(userQuery, true); 

            if (result.error) {
                addMessageToChatModalUI(result.error, 'ai'); 
            } else {
                addMessageToChatModalUI(result.text, 'ai'); 
            }

            chatLoadingModalEl.style.display = 'none'; 
            sendChatModalBtn.disabled = false; 
            chatInputModalEl.focus(); 
        }

        if (sendChatModalBtn) {
            sendChatModalBtn.onclick = handleSendChatModalMessage;
        }
        if (chatInputModalEl) {
            chatInputModalEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') { 
                    handleSendChatModalMessage();
                }
            });
        }
        
        if (tongtongChatToggleButton && tongtongChatModalContainer) {
            tongtongChatToggleButton.onclick = () => {
                const isHidden = tongtongChatModalContainer.style.display === 'none';
                tongtongChatModalContainer.style.display = isHidden ? 'flex' : 'none'; 
                tongtongChatToggleButton.textContent = isHidden ? 'ğŸ’¬ æ”¶èµ·èŠå¤©æ¡†' : 'ğŸ’¬ å’Œé€šé€šèŠèŠå¤©';
                updateBackButtonVisibility(); 
            };
        }
        if (closeChatModalBtn && tongtongChatModalContainer) {
            closeChatModalBtn.onclick = () => {
                tongtongChatModalContainer.style.display = 'none';
                if (tongtongChatToggleButton) tongtongChatToggleButton.textContent = 'ğŸ’¬ å’Œé€šé€šèŠèŠå¤©';
                updateBackButtonVisibility();
            };
        }


        // --- Navigation and UI State Management ---
        function updateBackButtonVisibility() {
            const backButton = document.getElementById('global-back-button');
            if (!backButton) return;

            const isHotspotVisible = hotspotPopup && hotspotPopup.style.display === 'block';
            const isMessageModalVisible = messageModal && messageModal.style.display === 'flex';
            const isProductDetailVisible = productDetailModal && productDetailModal.style.display === 'flex';
            const isQrCodeModalVisible = qrCodeModal && qrCodeModal.style.display === 'flex';
            const gameMessageBoxOverlay = document.getElementById('message-box-overlay');
            const isGameModalVisible = gameMessageBoxOverlay && gameMessageBoxOverlay.classList.contains('visible');
            const isChatModalVisible = tongtongChatModalContainer && tongtongChatModalContainer.style.display === 'flex'; 

            const isAnyModalVisible = isHotspotVisible || isMessageModalVisible || isProductDetailVisible || isQrCodeModalVisible || isGameModalVisible || isChatModalVisible;

            // Handle global back button state
            if (currentSection !== 'section-welcome' && !isAnyModalVisible) {
                backButton.style.display = 'flex'; 
                backButton.classList.remove('disabled'); 
            } else if (currentSection !== 'section-welcome' && isAnyModalVisible) {
                backButton.style.display = 'flex'; 
                backButton.classList.add('disabled'); 
            } else {
                backButton.style.display = 'none'; 
                backButton.classList.remove('disabled');
            }

            // MODIFIED: Handle disabling/enabling interactive elements on section-explore
            const exploreInteractives = document.querySelectorAll('#section-explore .explore-interactive');
            if (currentSection === 'section-explore') {
                if (isAnyModalVisible) { // If any modal is visible ON THE EXPLORE PAGE
                    exploreInteractives.forEach(el => {
                        el.style.pointerEvents = 'none';
                        el.style.opacity = '0.4';
                        el.style.filter = 'blur(1px)';
                    });
                } else {
                    exploreInteractives.forEach(el => {
                        el.style.pointerEvents = '';
                        el.style.opacity = '';
                        el.style.filter = '';
                    });
                }
            } else { // If not on explore section, ensure its elements are interactive
                 exploreInteractives.forEach(el => {
                    el.style.pointerEvents = '';
                    el.style.opacity = '';
                    el.style.filter = '';
                });
            }
        }

        function resetClickerGame() {
            gameActive = false; 
            clearInterval(gameInterval); 
            clearInterval(tongtongSpawnInterval); 
            gameScore = 0; gameTime = 10; 
            if (gameScoreDisplay) gameScoreDisplay.textContent = gameScore;
            if (gameTimerDisplay) gameTimerDisplay.textContent = gameTime;
            if (startGameBtn) {
                startGameBtn.textContent = clickerGameCompletedOnce ? 'å†ç©ä¸€æ¬¡' : 'å¼€å§‹æ¸¸æˆ';
                startGameBtn.disabled = false;
            }
            if (toProductsBtn) toProductsBtn.style.display = clickerGameCompletedOnce ? 'inline-block' : 'none';
            if (gameArea) gameArea.querySelectorAll('.game-tongtong').forEach(el => el.remove());
        }

        function resetMazeGame() {
            mazeGameActive = false; 
            clearInterval(mazeTimerInterval); 
            if (mazeBackgroundMusic) { mazeBackgroundMusic.pause(); mazeBackgroundMusic.currentTime = 0; }
            if (mazeWinMusic) { mazeWinMusic.pause(); mazeWinMusic.currentTime = 0; }
            mazeTimeElapsed = 0; 
            if (updateMazeTimerDisplay) updateMazeTimerDisplay(); 
            if (startMazeBtn) {
                startMazeBtn.textContent = mazeGameWonOnce ? 'å†ç©ä¸€æ¬¡' : 'å¼€å§‹æ¸¸æˆ';
                startMazeBtn.disabled = false;
            }
            if (mazeToProductsBtn) mazeToProductsBtn.style.display = mazeGameWonOnce ? 'inline-block' : 'none';
            if (mazeCtx && mazeCanvas) mazeCtx.clearRect(0, 0, mazeCanvas.width, mazeCanvas.height); 
        }

        function cleanupMatchGame() {
            const gameContext = window.matchGameContext;
            if (gameContext.timerInterval) { clearInterval(gameContext.timerInterval); gameContext.timerInterval = null; }

            if (gameContext.gameStarted && !gameContext.matchGameCompletedOnce && !gameContext.isFinishingSequence) {
                gameContext.gameStarted = false;
            }
            
            if (typeof gameContext.setGameActive === 'function') gameContext.setGameActive(false); 
            if (typeof gameContext.resetHint === 'function') gameContext.resetHint(); 

            const matchGameMusicIcon = gameContext.matchGameMusicToggleBtn ? gameContext.matchGameMusicToggleBtn.querySelector('img') : null;
            if (matchGameMusicIcon) {
                 const iconSrc = gameContext.isMatchGameMusicOn ? 'music_on.png' : 'music_off.png';
                 matchGameMusicIcon.src = iconSrc;
                 matchGameMusicIcon.alt = gameContext.isMatchGameMusicOn ? 'Music On' : 'Music Off';
                 matchGameMusicIcon.onerror = () => { 
                    matchGameMusicIcon.parentElement.innerHTML = `<span style="font-size:12px;">ğŸµ${gameContext.isMatchGameMusicOn ? 'On':'Off'}</span>`;
                 };
            }
        }

        function navigateTo(sectionId, isBackNavigation = false) {
            const nextSection = document.getElementById(sectionId); 
            if (nextSection) {
                const currentActiveSectionElement = document.querySelector('.section.active-section'); 
                
                if (currentActiveSectionElement) {
                    if (!isBackNavigation && currentSection !== sectionId) {
                        navigationHistory.push(currentSection);
                    }

                    if (currentActiveSectionElement.id === 'section-game') resetClickerGame();
                    else if (currentActiveSectionElement.id === 'section-maze') resetMazeGame();
                    else if (currentActiveSectionElement.id === 'section-match-game') cleanupMatchGame(); 
                    
                    currentActiveSectionElement.classList.remove('active-section'); 
                }

                if (sectionId === 'section-game') resetClickerGame(); 
                else if (sectionId === 'section-maze') resetMazeGame(); 
                else if (sectionId === 'section-match-game') {
                    if (!window.matchGameInitialized) { 
                        initMatchGame(); window.matchGameInitialized = true;
                    }
                    if (typeof window.matchGameContext.prepareForView === 'function') {
                        window.matchGameContext.prepareForView(); 
                    }
                } else if (sectionId === 'section-explore') { 
                    if (tongtongChatModalContainer) tongtongChatModalContainer.style.display = 'none'; 
                    if (tongtongChatToggleButton) tongtongChatToggleButton.textContent = 'ğŸ’¬ å’Œé€šé€šèŠèŠå¤©';
                }


                nextSection.classList.add('active-section'); 
                currentSection = sectionId; 
                window.scrollTo(0, 0); 
                updateBackButtonVisibility(); 
            } else {
                console.error("Section with ID " + sectionId + " not found.");
            }
        }

        function navigateBack() {
            const backButton = document.getElementById('global-back-button');
            if (backButton && backButton.classList.contains('disabled')) return; 

            if (navigationHistory.length > 0) {
                const previousSectionId = navigationHistory.pop(); 
                navigateTo(previousSectionId, true); 
            } else {
                let fallbackSectionId = 'section-welcome'; 
                if (currentSection === 'section-explore') fallbackSectionId = 'section-welcome';
                else if (['section-game', 'section-maze', 'section-match-game'].includes(currentSection)) fallbackSectionId = 'section-explore';
                else if (currentSection === 'section-products') fallbackSectionId = 'section-explore'; 
                else if (currentSection === 'section-draw') fallbackSectionId = 'section-products';
                else if (currentSection === 'section-cta') fallbackSectionId = 'section-draw';

                if (currentSection !== fallbackSectionId && currentSection !== 'section-welcome') {
                    navigateTo(fallbackSectionId, true);
                } else if (currentSection !== 'section-welcome' && fallbackSectionId === 'section-welcome') {
                    navigateTo('section-welcome', true);
                }
            }
        }

        function showHotspotInfo(title, text) {
            if(hotspotTitle) hotspotTitle.textContent = title;
            if(hotspotText) hotspotText.textContent = text;
            
            if(aiHotspotContent) aiHotspotContent.innerHTML = '';
            if(aiHotspotLoading) aiHotspotLoading.style.display = 'none';

            const noAIHotspots = ['é€šé€šçš„è§¦è§’', 'é€šé€šçš„ç¬‘è„¸', 'æ‹ŸäººåŒ–å¤–è§‚']; 
            if (noAIHotspots.includes(title)) {
                if(enhanceHotspotBtn) enhanceHotspotBtn.style.display = 'none';
            } else {
                if(enhanceHotspotBtn) {
                    enhanceHotspotBtn.style.display = 'block'; 
                    enhanceHotspotBtn.onclick = () => getAIEnhancedHotspotInfo(title, text);
                }
            }
            if(hotspotPopup) hotspotPopup.style.display = 'block'; 
            updateBackButtonVisibility(); 
        }
        function closeHotspotInfo() {
            if(hotspotPopup) hotspotPopup.style.display = 'none'; updateBackButtonVisibility();
        }

        // --- Clicker Game Logic ---
        const gameArea = document.getElementById('game-area');
        const gameScoreDisplay = document.getElementById('game-score');
        const gameTimerDisplay = document.getElementById('game-timer');
        const startGameBtn = document.getElementById('start-game-btn');
        const toProductsBtn = document.getElementById('to-products-btn'); 
        let gameScore = 0, gameTime = 10, gameInterval, tongtongSpawnInterval, gameActive = false;
        const clickSound = new Audio('ks.mp3'); 
        let isClickGameMusicOn = true; 
        const clickGameMusicToggleBtn = document.getElementById('click-game-music-toggle');
        const clickGameMusicIcon = clickGameMusicToggleBtn ? clickGameMusicToggleBtn.querySelector('img') : null;

        if (clickGameMusicToggleBtn && clickGameMusicIcon) {
            clickGameMusicToggleBtn.onclick = () => {
                isClickGameMusicOn = !isClickGameMusicOn;
                const newIconSrc = isClickGameMusicOn ? 'music_on.png' : 'music_off.png';
                clickGameMusicIcon.src = newIconSrc; clickGameMusicIcon.alt = isClickGameMusicOn ? 'Music On' : 'Music Off';
                clickGameMusicIcon.onerror = () => { 
                    clickGameMusicIcon.parentElement.innerHTML = `<span style="font-size:12px;">ğŸµ${isClickGameMusicOn ? 'On':'Off'}</span>`;
                };
            };
        }

        function startGame() {
            gameScore = 0; gameTime = 10; gameActive = true; 
            if (gameScoreDisplay) gameScoreDisplay.textContent = gameScore;
            if (gameTimerDisplay) gameTimerDisplay.textContent = gameTime;
            if (startGameBtn) { startGameBtn.textContent = 'æ¸¸æˆä¸­...'; startGameBtn.disabled = true; }
            if (toProductsBtn) toProductsBtn.style.display = 'none'; 
            if (gameArea) gameArea.querySelectorAll('.game-tongtong').forEach(el => el.remove()); 
            
            gameInterval = setInterval(() => {
                gameTime--; 
                if(gameTimerDisplay) gameTimerDisplay.textContent = gameTime;
                if (gameTime <= 0) endGame(true); 
            }, 1000);
            
            tongtongSpawnInterval = setInterval(spawnTongTong, 700); 
            spawnTongTong(); 
        }

        function spawnTongTong() {
            if (!gameActive || gameTime <= 0 || !gameArea) return; 
            if (gameArea.querySelectorAll('.game-tongtong').length >= 3) return; 

            const tongtongElement = document.createElement('div');
            tongtongElement.classList.add('game-tongtong');
            tongtongElement.onerror = function() {
                this.style.backgroundImage = 'none'; this.style.backgroundColor = '#FF6600'; 
                const placeholderText = document.createElement('span');
                placeholderText.textContent = 'é€š'; placeholderText.style.color = 'white';
                placeholderText.style.fontSize = '30px'; placeholderText.style.lineHeight = '60px';
                this.appendChild(placeholderText);
            };

            const gameAreaRect = gameArea.getBoundingClientRect(); const tongtongSize = 60;
            const randomX = Math.max(0, Math.random() * (gameAreaRect.width - tongtongSize));
            const randomY = Math.max(0, Math.random() * (gameAreaRect.height - tongtongSize));
            tongtongElement.style.left = randomX + 'px'; tongtongElement.style.top = randomY + 'px';
            
            tongtongElement.onclick = () => {
                if (gameActive && gameTime > 0) {
                    gameScore++; 
                    if(gameScoreDisplay) gameScoreDisplay.textContent = gameScore;
                    if (isClickGameMusicOn && clickSound) { clickSound.currentTime = 0; clickSound.play().catch(e => console.warn("Error playing click sound:", e)); }
                    tongtongElement.remove(); 
                }
            };
            gameArea.appendChild(tongtongElement);

            setTimeout(() => {
                if (tongtongElement.parentElement) { 
                    tongtongElement.style.opacity = '0'; 
                    setTimeout(() => tongtongElement.remove(), 300); 
                }
            }, 1000 + Math.random() * 200); 
        }

        function endGame(showModal = true) {
            gameActive = false; 
            clearInterval(gameInterval); clearInterval(tongtongSpawnInterval); 
            if(gameArea) gameArea.querySelectorAll('.game-tongtong').forEach(tt => tt.remove()); 
            
            if (showModal) {
                showMessage('æ¸¸æˆç»“æŸ!', `å¤ªæ£’äº†ï¼ä½ è·å¾—äº† ${gameScore} åˆ†!`);
                clickerGameCompletedOnce = true; 
            } else { 
                updateBackButtonVisibility(); 
            }
            if(startGameBtn) { startGameBtn.textContent = 'å†ç©ä¸€æ¬¡'; startGameBtn.disabled = false; }
            if(toProductsBtn) toProductsBtn.style.display = clickerGameCompletedOnce ? 'inline-block' : 'none'; 
        }

        // --- Draw Section Logic ---
        const drawButton = document.getElementById('draw-button');
        const prizes = ["é€šé€šæ–‡åˆ›9æŠ˜ä¼˜æƒ åˆ¸ï¼", "é€šé€šé™é‡ç‰ˆè´´çº¸ä¸€å¥—ï¼", "è”é€š5å…ƒè¯è´¹æŠµæ‰£åˆ¸ï¼", "é€šé€šä¸“å±æ‰‹æœºå£çº¸ä¸‹è½½ï¼"];
        let hasDrawn = false; 
        function performDraw() {
            if (hasDrawn) { showMessage('æç¤º', 'æ‚¨å·²ç»æŠ½è¿‡å¥–å•¦ï¼Œçœ‹çœ‹å…¶ä»–æ´»åŠ¨å§ï¼'); return; }
            const prizeWon = prizes[Math.floor(Math.random() * prizes.length)]; 
            showMessage('æŠ½å¥–ç»“æœ', `æ­å–œä½ ï¼æŠ½ä¸­äº†ï¼š${prizeWon}`);
            if(drawButton) { drawButton.textContent = 'å·²æŠ½å¥–'; drawButton.disabled = true; }
            hasDrawn = true;
        }

        // --- Product Detail Modal Logic ---
        function showProductDetail(element) {
            if (!productDetailModal || !element || !element.dataset) return;
            
            if(productDetailImage) {
                productDetailImage.src = element.dataset.imgSrc || ''; 
            }
            const productNameKey = element.dataset.name || 'äº§å“åç§°'; 
            if(productDetailName) productDetailName.textContent = productNameKey;
            if(productDetailPrice) productDetailPrice.textContent = element.dataset.price || 'ä»·æ ¼å¾…å®š';

            if (productDetailDescription) productDetailDescription.innerHTML = ''; 
            if (aiDescriptionLoader) aiDescriptionLoader.style.display = 'block'; 
            
            const imageBasedDesc = element.dataset.description || 'æš‚æ— è¯¦ç»†æè¿°ã€‚'; 
            const finalFallbackText = finalFallbackProductDescriptions[productNameKey] || imageBasedDesc; 

            getAIEnhancedProductDescription(
                productNameKey, 
                imageBasedDesc, 
                productDetailDescription, 
                aiDescriptionLoader,
                finalFallbackText 
            );
            
            if(productDetailBuyButton) {
                productDetailBuyButton.onclick = () => {
                    showMessage('è´­ä¹°æç¤º', `æ„Ÿè°¢æ‚¨æœ‰å…´è¶£è´­ä¹° ${productNameKey}ï¼æ­¤åŠŸèƒ½æ­£åœ¨å»ºè®¾ä¸­ã€‚`);
                    closeProductDetailModal();
                };
            }
            productDetailModal.style.display = 'flex'; 
            updateBackButtonVisibility(); 
        }

        function closeProductDetailModal() {
            if(productDetailModal) productDetailModal.style.display = 'none'; updateBackButtonVisibility();
        }

        // --- QR Code Modal Logic ---
        function showQrCodeModal() { if (qrCodeModal) { qrCodeModal.style.display = 'flex'; updateBackButtonVisibility(); } }
        function closeQrCodeModal() { if (qrCodeModal) { qrCodeModal.style.display = 'none'; updateBackButtonVisibility(); } }


        // --- Maze Game Logic ---
        const mazeCanvas = document.getElementById('mazeCanvas');
        const mazeCtx = mazeCanvas ? mazeCanvas.getContext('2d') : null;
        const startMazeBtn = document.getElementById('start-maze-btn');
        const mazeToProductsBtn = document.getElementById('maze-to-products-btn');
        const mazeTimeDisplay = document.getElementById('maze-time-display');
        const mazeBackgroundMusic = new Audio('mggc.mp3'); 
        const mazeWinMusic = new Audio('mgcg.mp3'); 
        let isMazeMusicOn = true; 
        const mazeGameMusicToggleBtn = document.getElementById('maze-game-music-toggle');
        const mazeGameMusicIcon = mazeGameMusicToggleBtn ? mazeGameMusicToggleBtn.querySelector('img') : null;

        const playerMazeImgDefault = new Image(), playerMazeImgUp = new Image(), playerMazeImgDown = new Image(),
              playerMazeImgLeft = new Image(), playerMazeImgRight = new Image(), endMazeImg = new Image();
        playerMazeImgDefault.src = 'xia.png'; playerMazeImgUp.src = 'shang.png'; playerMazeImgDown.src = 'xia.png';
        playerMazeImgLeft.src = 'zuo.png'; playerMazeImgRight.src = 'you.png'; endMazeImg.src = 'zgj.png';
        let currentPlayerMazeImg = playerMazeImgDefault; 

        [playerMazeImgDefault, playerMazeImgUp, playerMazeImgDown, playerMazeImgLeft, playerMazeImgRight, endMazeImg].forEach(img => {
            img.onload = () => { if (currentSection === 'section-maze' && mazeGameActive && (img === currentPlayerMazeImg || img === endMazeImg)) drawMaze(); };
            img.onerror = () => { 
                console.warn(`Maze image ${img.src} failed to load.`);
                if (currentSection === 'section-maze' && mazeGameActive) drawMaze(); 
            };
        });

        if (mazeGameMusicToggleBtn && mazeGameMusicIcon) {
            mazeGameMusicToggleBtn.onclick = () => {
                isMazeMusicOn = !isMazeMusicOn;
                const newIconSrc = isMazeMusicOn ? 'music_on.png' : 'music_off.png';
                mazeGameMusicIcon.src = newIconSrc; mazeGameMusicIcon.alt = isMazeMusicOn ? 'Music On' : 'Music Off';
                mazeGameMusicIcon.onerror = () => { 
                    mazeGameMusicIcon.parentElement.innerHTML = `<span style="font-size:12px;">ğŸµ${isMazeMusicOn ? 'On':'Off'}</span>`;
                };
                if (isMazeMusicOn) {
                    if (mazeGameActive && !(playerMazePos.x === endMazePos.x && playerMazePos.y === endMazePos.y)) { 
                        mazeBackgroundMusic.play().catch(e => console.warn("Error playing maze background music:", e));
                    }
                } else { 
                    if(mazeBackgroundMusic) mazeBackgroundMusic.pause(); 
                    if(mazeWinMusic) { mazeWinMusic.pause(); mazeWinMusic.currentTime = 0; }
                }
            };
        }

        let mazeGrid = [], playerMazePos = { x: 0, y: 0 }, endMazePos = { x: 0, y: 0 };
        const mazeCols = 10, mazeRows = 10; 
        let mazeCellSize, mazeTimerInterval, mazeTimeElapsed = 0, mazeGameActive = false;
        
        function updateMazeTimerDisplay() { if(mazeTimeDisplay) mazeTimeDisplay.textContent = mazeTimeElapsed; }
        
        function generateMaze(cols, rows) {
            mazeGrid = [];
            for (let r = 0; r < rows; r++) {
                mazeGrid[r] = [];
                for (let c = 0; c < cols; c++) {
                    mazeGrid[r][c] = { r: r, c: c, walls: { top: true, right: true, bottom: true, left: true }, visited: false };
                }
            }
            playerMazePos = { x: 0, y: 0 }; 
            endMazePos = { x: cols - 1, y: rows - 1 }; 

            let stack = []; 
            let current = mazeGrid[playerMazePos.y][playerMazePos.x];
            current.visited = true; 
            stack.push(current);

            while (stack.length > 0) {
                current = stack[stack.length - 1]; 
                let neighbors = []; 
                const {r, c} = current;
                if (r > 0 && !mazeGrid[r-1][c].visited) neighbors.push(mazeGrid[r-1][c]);
                if (c < cols-1 && !mazeGrid[r][c+1].visited) neighbors.push(mazeGrid[r][c+1]);
                if (r < rows-1 && !mazeGrid[r+1][c].visited) neighbors.push(mazeGrid[r+1][c]);
                if (c > 0 && !mazeGrid[r][c-1].visited) neighbors.push(mazeGrid[r][c-1]);

                if (neighbors.length > 0) {
                    let next = neighbors[Math.floor(Math.random() * neighbors.length)]; 
                    if (next.r < current.r) { current.walls.top = false; next.walls.bottom = false; } 
                    else if (next.c > current.c) { current.walls.right = false; next.walls.left = false; } 
                    else if (next.r > current.r) { current.walls.bottom = false; next.walls.top = false; } 
                    else if (next.c < current.c) { current.walls.left = false; next.walls.right = false; } 
                    next.visited = true; 
                    stack.push(next); 
                } else { 
                    stack.pop(); 
                }
            }
            return mazeGrid;
        }
        
        function drawMaze() {
            if (!mazeCanvas || !mazeCtx || !mazeGrid || mazeGrid.length === 0) return;
            mazeCtx.clearRect(0, 0, mazeCanvas.width, mazeCanvas.height); 
            mazeCtx.strokeStyle = '#FFFFFF'; 
            mazeCtx.lineWidth = Math.max(2, Math.floor(mazeCellSize / 11)); 

            for (let r = 0; r < mazeRows; r++) {
                for (let c = 0; c < mazeCols; c++) {
                    if (!mazeGrid[r] || !mazeGrid[r][c]) continue; 
                    let cell = mazeGrid[r][c]; 
                    let x = c * mazeCellSize; 
                    let y = r * mazeCellSize;
                    if (cell.walls.top) { mazeCtx.beginPath(); mazeCtx.moveTo(x, y); mazeCtx.lineTo(x + mazeCellSize, y); mazeCtx.stroke(); }
                    if (cell.walls.right) { mazeCtx.beginPath(); mazeCtx.moveTo(x + mazeCellSize, y); mazeCtx.lineTo(x + mazeCellSize, y + mazeCellSize); mazeCtx.stroke(); }
                    if (cell.walls.bottom) { mazeCtx.beginPath(); mazeCtx.moveTo(x + mazeCellSize, y + mazeCellSize); mazeCtx.lineTo(x, y + mazeCellSize); mazeCtx.stroke(); }
                    if (cell.walls.left) { mazeCtx.beginPath(); mazeCtx.moveTo(x, y + mazeCellSize); mazeCtx.lineTo(x, y); mazeCtx.stroke(); }
                }
            }

            const imgPadding = mazeCellSize * 0.1; 
            const imgDrawSize = mazeCellSize * 0.8; 
            
            const playerImgToDraw = currentPlayerMazeImg || playerMazeImgDefault; 
            if (playerImgToDraw && playerImgToDraw.complete && playerImgToDraw.naturalWidth !== 0) {
                mazeCtx.drawImage(playerImgToDraw, playerMazePos.x * mazeCellSize + imgPadding, playerMazePos.y * mazeCellSize + imgPadding, imgDrawSize, imgDrawSize);
            } else { 
                mazeCtx.fillStyle = 'rgba(220, 38, 38, 0.8)'; 
                mazeCtx.fillRect(playerMazePos.x * mazeCellSize + imgPadding, playerMazePos.y * mazeCellSize + imgPadding, imgDrawSize, imgDrawSize);
            }
            
            const goalImgToDraw = endMazeImg;
            if (goalImgToDraw && goalImgToDraw.complete && goalImgToDraw.naturalWidth !== 0) {
                const endImgAspectRatio = goalImgToDraw.naturalWidth / goalImgToDraw.naturalHeight;
                let endImgDrawWidth = imgDrawSize; 
                let endImgDrawHeight = imgDrawSize / endImgAspectRatio;
                if (endImgDrawHeight > imgDrawSize) { endImgDrawHeight = imgDrawSize; endImgDrawWidth = imgDrawSize * endImgAspectRatio; } 
                mazeCtx.drawImage(goalImgToDraw, endMazePos.x * mazeCellSize + (mazeCellSize - endImgDrawWidth) / 2, endMazePos.y * mazeCellSize + (mazeCellSize - endImgDrawHeight) / 2, endImgDrawWidth, endImgDrawHeight);
            } else { 
                mazeCtx.fillStyle = 'rgba(22, 163, 74, 0.8)'; 
                mazeCtx.fillRect(endMazePos.x * mazeCellSize + imgPadding, endMazePos.y * mazeCellSize + imgPadding, imgDrawSize, imgDrawSize);
            }
        }
        
        function movePlayerMaze(direction) {
            if (!mazeGameActive || !mazeGrid.length || !mazeGrid[playerMazePos.y] || !mazeGrid[playerMazePos.y][playerMazePos.x]) return;
            let currentCell = mazeGrid[playerMazePos.y][playerMazePos.x];
            let newX = playerMazePos.x, newY = playerMazePos.y, moved = false;
            
            switch (direction) {
                case 'up': if (!currentCell.walls.top && playerMazePos.y > 0) { newY--; currentPlayerMazeImg = playerMazeImgUp; moved = true; } break;
                case 'down': if (!currentCell.walls.bottom && playerMazePos.y < mazeRows - 1) { newY++; currentPlayerMazeImg = playerMazeImgDown; moved = true; } break;
                case 'left': if (!currentCell.walls.left && playerMazePos.x > 0) { newX--; currentPlayerMazeImg = playerMazeImgLeft; moved = true; } break;
                case 'right': if (!currentCell.walls.right && playerMazePos.x < mazeCols - 1) { newX++; currentPlayerMazeImg = playerMazeImgRight; moved = true; } break;
            }
            if (moved) { 
                playerMazePos.x = newX; playerMazePos.y = newY; 
                drawMaze(); 
                checkMazeWinCondition(); 
            }
        }
        
        function checkMazeWinCondition() {
            if (playerMazePos.x === endMazePos.x && playerMazePos.y === endMazePos.y) {
                mazeGameActive = false; 
                clearInterval(mazeTimerInterval); 
                if(mazeBackgroundMusic) { mazeBackgroundMusic.pause(); mazeBackgroundMusic.currentTime = 0; }
                if (isMazeMusicOn && mazeWinMusic) mazeWinMusic.play().catch(e => console.warn("Error playing maze win music:", e));
                mazeGameWonOnce = true; 
                showMessage('å¤ªæ£’äº†!', `ä½ æˆåŠŸå¸®åŠ©é€šé€šèµ°å‡ºè¿·å®«ï¼Œæ‰¾åˆ°äº†ä¸­å›½ç»“ï¼ç”¨æ—¶ ${mazeTimeElapsed} ç§’ï¼`);
                if(startMazeBtn) { startMazeBtn.textContent = 'å†ç©ä¸€æ¬¡'; startMazeBtn.disabled = false; }
                if(mazeToProductsBtn) mazeToProductsBtn.style.display = 'inline-block'; 
            }
        }
        
        function startMazeGame() {
            if (!mazeCanvas) { console.error("Maze canvas not found!"); return; }
            mazeGameActive = true; mazeTimeElapsed = 0; 
            if(updateMazeTimerDisplay) updateMazeTimerDisplay();
            if(startMazeBtn) { startMazeBtn.textContent = 'æ¸¸æˆä¸­...'; startMazeBtn.disabled = true; }
            if(mazeToProductsBtn) mazeToProductsBtn.style.display = 'none'; 
            clearInterval(mazeTimerInterval); 
            mazeTimerInterval = setInterval(() => { if (mazeGameActive) { mazeTimeElapsed++; updateMazeTimerDisplay(); }}, 1000); 
            
            mazeCellSize = mazeCanvas.width / mazeCols; 
            currentPlayerMazeImg = playerMazeImgDefault; 
            playerMazePos = { x: 0, y: 0 }; 
            mazeGrid = generateMaze(mazeCols, mazeRows); 
            
            if(mazeWinMusic) { mazeWinMusic.pause(); mazeWinMusic.currentTime = 0; } 
            if (isMazeMusicOn && mazeBackgroundMusic) {
                mazeBackgroundMusic.loop = true; 
                mazeBackgroundMusic.play().catch(e => console.warn("Error playing maze background music:", e));
            } else if (mazeBackgroundMusic) { 
                mazeBackgroundMusic.pause(); mazeBackgroundMusic.currentTime = 0; 
            }
            drawMaze(); 
            updateBackButtonVisibility(); 
        }
        
        document.addEventListener('keydown', (e) => {
            if (currentSection === 'section-maze' && mazeGameActive) {
                let direction = null;
                if (e.key === 'ArrowUp') direction = 'up'; 
                else if (e.key === 'ArrowDown') direction = 'down';
                else if (e.key === 'ArrowLeft') direction = 'left'; 
                else if (e.key === 'ArrowRight') direction = 'right';
                if (direction) { e.preventDefault(); movePlayerMaze(direction); }
            }
        });
        
        document.querySelectorAll('.maze-arrow-button').forEach(button => {
            const direction = button.dataset.direction; if (!direction) return;
            const pressHandler = () => { if (currentSection === 'section-maze' && mazeGameActive) movePlayerMaze(direction); button.classList.add('pressed'); };
            const releaseHandler = () => { button.classList.remove('pressed'); };
            button.addEventListener('mousedown', pressHandler); 
            button.addEventListener('mouseup', releaseHandler);
            button.addEventListener('mouseleave', () => button.classList.remove('pressed')); 
            button.addEventListener('touchstart', (e) => { e.preventDefault(); pressHandler(); }, { passive: false });
            button.addEventListener('touchend', (e) => { e.preventDefault(); releaseHandler(); });
        });

        // --- Match-3 Game Logic (æ¶ˆæ¶ˆä¹) ---
        function initMatchGame() {
            const gameContext = window.matchGameContext; 

            gameContext.size = 8; 
            gameContext.gameDuration = 60; 
            gameContext.initialHintCount = 2; 
            gameContext.R_AUTO_MATCH = 0.15; 
            gameContext.R_SETUP_MOVE = 0.25; 
            gameContext.images = [
                'æ¶ˆæ¶ˆä¹/ä¿æ¸©æ¯.jpg', 'æ¶ˆæ¶ˆä¹/å……ç”µçº¿.jpg',
                'æ¶ˆæ¶ˆä¹/åœ°çƒæ¬¾é’¥åŒ™æ‰£.jpg', 'æ¶ˆæ¶ˆä¹/å‰ç¥¥ç‰©æ¯›ç»’ç©å…·.jpg',
                'æ¶ˆæ¶ˆä¹/é‡‘è‰²é€šé€šæ‰‹åŠ.jpg', 'æ¶ˆæ¶ˆä¹/æ‰‹æœºæŒ‚ç»³.jpg',
                'æ¶ˆæ¶ˆä¹/å››æ–¹åŸºç«™å¾½ç« .jpg', 'æ¶ˆæ¶ˆä¹/é¦™å¡.jpg',
                'æ¶ˆæ¶ˆä¹/æ—‹è½¬æ¬¾é’¥åŒ™æ‰£.jpg'
            ];

            gameContext.board = []; 
            gameContext.selected = null; 
            gameContext.score = 0;
            gameContext.timeLeft = gameContext.gameDuration;
            gameContext.timerInterval = null; 
            gameContext.gameStarted = false; 
            gameContext.hintCount = gameContext.initialHintCount;
            gameContext.hintPair = null; 
            gameContext.isProcessingMove = false; 
            gameContext.isGamePausedForShuffle = false; 
            gameContext._xxlHintSwap = false; 
            gameContext.isFinishingSequence = false; 
            gameContext.hintUsedAndNotResolved = false; 

            const gameSection = document.getElementById('section-match-game');
            if (!gameSection) { console.error("Match game section not found!"); return; }
            gameContext.boardEl = gameSection.querySelector('#game-board');
            gameContext.scoreEl = gameSection.querySelector('#score');
            gameContext.timerEl = gameSection.querySelector('#timer');
            gameContext.actionBtn = gameSection.querySelector('#action-btn'); 
            gameContext.hintBtn = gameSection.querySelector('#hint-btn');
            gameContext.hintCountEl = gameSection.querySelector('#hint-count-display');
            gameContext.messageBoxOverlay = gameSection.querySelector('#message-box-overlay'); 
            gameContext.messageBoxText = gameSection.querySelector('#message-box-text');
            gameContext.messageBoxOk = gameSection.querySelector('#message-box-ok');
            gameContext.matchGameToProductsBtn = gameSection.querySelector('#match-game-to-products-btn'); 
            gameContext.matchGameMusicToggleBtn = gameSection.querySelector('#match-game-music-toggle');
            gameContext.matchGameMusicIcon = gameContext.matchGameMusicToggleBtn ? gameContext.matchGameMusicToggleBtn.querySelector('img') : null;

            gameContext.matchSound = null; 
            gameContext.errorSoundTone = null; 
            gameContext.clickSoundTone = null; 
            gameContext.soundsInitialized = false; 

            try { 
                gameContext.matchSound = new Audio('xiaochu.mp3'); 
            } catch (e) {
                console.warn("Error initializing matchSound Audio object. Match sound might not play.", e);
                gameContext.matchSound = { play: () => {}, currentTime: 0 }; 
            }

            gameContext.initializeToneSounds = function() {
                if (gameContext.soundsInitialized || typeof Tone === 'undefined') return;
                try {
                    gameContext.errorSoundTone = new Tone.Synth({ 
                        oscillator: { type: "square" }, 
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } 
                    }).toDestination();
                    gameContext.clickSoundTone = new Tone.MembraneSynth({ 
                        octaves: 4, pitchDecay: 0.1, 
                        envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } 
                    }).toDestination();
                    gameContext.soundsInitialized = true; 
                } catch (e) { console.warn("Error initializing Tone.js sounds for match game.", e); }
            };
            gameContext.playMatchSound = function() {
                if (gameContext.isMatchGameMusicOn && gameContext.matchSound && typeof gameContext.matchSound.play === 'function') { 
                    gameContext.matchSound.currentTime = 0; 
                    gameContext.matchSound.play().catch(error => console.warn("Error playing match sound:", error.message));
                }
            };
            gameContext.playErrorSound = function() { 
                 if (gameContext.isMatchGameMusicOn && gameContext.soundsInitialized && gameContext.errorSoundTone) {
                    try { gameContext.errorSoundTone.triggerAttackRelease("A2", "8n", Tone.now()); } 
                    catch (e) { console.warn("Tone.js error sound playback failed:", e); }
                 }
            };
            gameContext.playClickSound = function() { 
                if (gameContext.isMatchGameMusicOn && gameContext.soundsInitialized && gameContext.clickSoundTone) {
                    try { gameContext.clickSoundTone.triggerAttackRelease("C4", "16n", Tone.now()); } 
                    catch (e) { console.warn("Tone.js click sound playback failed:", e); }
                }
            };

            gameContext.xxl_showMessage = function(text, okCallback = null) {
                if (!gameContext.messageBoxText || !gameContext.messageBoxOverlay) return;
                gameContext.messageBoxText.textContent = text;
                gameContext.currentMessageOkCallback = okCallback; 
                gameContext.messageBoxOverlay.classList.add('visible');
                updateBackButtonVisibility(); 
            };
            if (gameContext.messageBoxOk) {
                gameContext.messageBoxOk.onclick = () => {
                    if (gameContext.currentMessageOkCallback) { gameContext.currentMessageOkCallback(); gameContext.currentMessageOkCallback = null; }
                    if (gameContext.messageBoxOverlay) gameContext.messageBoxOverlay.classList.remove('visible');
                    updateBackButtonVisibility();
                };            
            }
            gameContext.setupBoardSize = function() {
                if (!gameContext.boardEl) return;
                gameContext.boardEl.style.gap = "6px"; 
                const parentElement = gameContext.boardEl.parentElement;
                let availableWidth = (parentElement && parentElement.clientWidth > 0) 
                    ? Math.min(parentElement.clientWidth * 0.95, 500) 
                    : Math.min(window.innerWidth * 0.90, 500); 
                const availableHeight = window.innerHeight * 0.6; 
                const boardSize = Math.min(availableWidth, availableHeight); 

                gameContext.boardEl.style.gridTemplateColumns = `repeat(${gameContext.size}, 1fr)`;
                gameContext.boardEl.style.gridTemplateRows = `repeat(${gameContext.size}, 1fr)`;
                gameContext.boardEl.style.width = `${boardSize}px`;
                gameContext.boardEl.style.height = `${boardSize}px`;
                gameContext.boardEl.style.maxWidth = "500px"; 
            };
            gameContext.boundSetupBoardSize = gameContext.setupBoardSize.bind(gameContext); 
            window.addEventListener('resize', gameContext.boundSetupBoardSize); 
            gameContext.removeResizeListener = () => window.removeEventListener('resize', gameContext.boundSetupBoardSize);

            gameContext.randomImage = function() { return Math.floor(Math.random() * gameContext.images.length); };
            
            gameContext.createBoard = function() {
                gameContext.board = [];
                for (let r = 0; r < gameContext.size; r++) {
                    let row = [];
                    for (let c = 0; c < gameContext.size; c++) {
                        row.push(gameContext.randomImage()); 
                    }
                    gameContext.board.push(row);
                }
                let initialClearSafety = 0; const MAX_INITIAL_CLEAR_LOOPS = 10; 
                while (initialClearSafety < MAX_INITIAL_CLEAR_LOOPS) {
                    initialClearSafety++;
                    let matches = gameContext.findMatchesOnBoard(gameContext.board);
                    if (matches.length === 0) { 
                        if (gameContext.findHintPairOnBoard(gameContext.board)) break; 
                        else { 
                            gameContext.shuffleBoard(); 
                            if (gameContext.findMatchesOnBoard(gameContext.board).length > 0 || !gameContext.findHintPairOnBoard(gameContext.board)) {
                                for (let r_fill = 0; r_fill < gameContext.size; r_fill++) { for (let c_fill = 0; c_fill < gameContext.size; c_fill++) { gameContext.board[r_fill][c_fill] = gameContext.randomImage();}}
                            } else { break; } 
                        }
                    }
                    let removed = Array.from({length: gameContext.size}, () => Array(gameContext.size).fill(false));
                    for (const m of matches) { 
                        for (let i = 0; i < m.len; i++) { 
                            let r_match = m.dir === 'h' ? m.r : m.r + i; 
                            let c_match = m.dir === 'h' ? m.c + i : m.c; 
                            if (!removed[r_match][c_match]) removed[r_match][c_match] = true; 
                        }
                    }
                    for (let r_rem = 0; r_rem < gameContext.size; r_rem++) { for (let c_rem = 0; c_rem < gameContext.size; c_rem++) { if (removed[r_rem][c_rem]) gameContext.board[r_rem][c_rem] = null; } }
                    for (let c_fall = 0; c_fall < gameContext.size; c_fall++) { 
                        let emptySlots = 0; 
                        for (let r_fall = gameContext.size - 1; r_fall >= 0; r_fall--) { 
                            if (gameContext.board[r_fall][c_fall] === null) { emptySlots++; } 
                            else if (emptySlots > 0) { 
                                gameContext.board[r_fall + emptySlots][c_fall] = gameContext.board[r_fall][c_fall]; 
                                gameContext.board[r_fall][c_fall] = null; 
                            } 
                        } 
                    }
                    for (let c_fill = 0; c_fill < gameContext.size; c_fill++) { for (let r_fill = 0; r_fill < gameContext.size; r_fill++) { if (gameContext.board[r_fill][c_fill] === null) { gameContext.board[r_fill][c_fill] = gameContext.randomImage(); }}}
                }
            };
                       
            gameContext.renderBoard = function(removedMap = null, fallMap = null) {
                if (!gameContext.boardEl || !gameContext.board) return; 
                gameContext.boardEl.innerHTML = ''; 
                let hintSwapActive = gameContext.hintPair && gameContext._xxlHintSwap; 

                for (let r = 0; r < gameContext.size; r++) { for (let c = 0; c < gameContext.size; c++) {
                    const cell = document.createElement('div'); 
                    cell.className = 'cell'; 
                    cell.dataset.row = r; cell.dataset.col = c;

                    if (gameContext.selected && gameContext.selected[0] === r && gameContext.selected[1] === c) cell.classList.add('selected');
                    if (removedMap && removedMap[r][c]) cell.classList.add('disappear'); 
                    if (fallMap && fallMap[r][c]) cell.classList.add('fall'); 
                    
                    if (gameContext.hintPair && ((gameContext.hintPair[0][0] === r && gameContext.hintPair[0][1] === c) || (gameContext.hintPair[1][0] === r && gameContext.hintPair[1][1] === c))) {
                        cell.classList.add('hint');
                        if (hintSwapActive) { 
                            cell.classList.add('hint-animate');                            
                            const targetCell = (gameContext.hintPair[0][0] === r && gameContext.hintPair[0][1] === c) ? gameContext.hintPair[1] : gameContext.hintPair[0];
                            const dx = (targetCell[1] - c); 
                            const dy = (targetCell[0] - r); 
                            cell.style.setProperty('--xxl-hint-x', `${dx * 120}%`); 
                            cell.style.setProperty('--xxl-hint-y', `${dy * 120}%`);
                        } else { 
                            cell.style.removeProperty('--xxl-hint-x'); cell.style.removeProperty('--xxl-hint-y');
                        }
                    }
                    
                    if (gameContext.board[r] && gameContext.board[r][c] !== null && gameContext.board[r][c] < gameContext.images.length) { 
                        const img = document.createElement('img'); 
                        img.src = gameContext.images[gameContext.board[r][c]]; 
                        img.alt = 'æ–‡åˆ›äº§å“'; 
                        img.onerror = () => { 
                            img.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥'; 
                            img.src = `https://placehold.co/50x50/CCCCCC/555555?text=${gameContext.board[r][c]}`; 
                        };
                        cell.appendChild(img);
                    }
                    cell.onclick = () => gameContext.handleCellClick(r, c); 
                    gameContext.boardEl.appendChild(cell);
                } }
            };
            gameContext.updateUI = function() {
                if(gameContext.scoreEl) gameContext.scoreEl.textContent = `åˆ†æ•°ï¼š${gameContext.score}`;
                if(gameContext.timerEl) gameContext.timerEl.textContent = `å‰©ä½™æ—¶é—´ï¼š${gameContext.timeLeft}ç§’`;
                if(gameContext.hintCountEl) gameContext.hintCountEl.textContent = `æç¤ºï¼š${gameContext.hintCount}æ¬¡`;
                
                const canInteract = gameContext.gameStarted && gameContext.timeLeft > 0 && !gameContext.isGamePausedForShuffle && !gameContext.isFinishingSequence;
                if(gameContext.actionBtn) gameContext.actionBtn.disabled = (gameContext.isProcessingMove && !gameContext.isGamePausedForShuffle) || canInteract; 
                if(gameContext.hintBtn) gameContext.hintBtn.disabled = gameContext.isProcessingMove || !canInteract || gameContext.hintCount <= 0 || gameContext.hintUsedAndNotResolved;
            };
            gameContext.setGameActive = function(active) {
                const allowPointerEvents = active && !gameContext.isProcessingMove && !gameContext.isGamePausedForShuffle && !gameContext.isFinishingSequence;
                if(gameContext.boardEl) gameContext.boardEl.style.pointerEvents = allowPointerEvents ? '' : 'none';
                gameContext.updateUI(); 
            };            
            gameContext.animateSwap = function(r1, c1, r2, c2, isBackSwap, callback) {
                gameContext.isProcessingMove = true; gameContext.setGameActive(false); 
                const idx1 = r1 * gameContext.size + c1; const idx2 = r2 * gameContext.size + c2;
                const cells = Array.from(gameContext.boardEl.children); const cell1 = cells[idx1]; const cell2 = cells[idx2];
                
                if (!cell1 || !cell2) { 
                    if (callback) callback(); 
                    gameContext.isProcessingMove = false; 
                    if (!gameContext.isFinishingSequence) { 
                        gameContext.setGameActive(gameContext.gameStarted && gameContext.timeLeft > 0 && !gameContext.isGamePausedForShuffle); 
                    }
                    return; 
                }
                const cellSize = cell1.offsetWidth;
                const cellGap = parseFloat(gameContext.boardEl.style.gap) || 6; 
                const dx = (c2 - c1) * (cellSize + cellGap); 
                const dy = (r2 - r1) * (cellSize + cellGap);
                const animationTime = isBackSwap ? 130 : 250; 
                
                if (!isBackSwap) { 
                    cell1.classList.add('swap'); cell2.classList.add('swap'); 
                    cell1.style.transform = `translate(${dx}px, ${dy}px)`; 
                    cell2.style.transform = `translate(${-dx}px, ${-dy}px)`; 
                } else { 
                    cell1.classList.add('swap-back-half'); cell2.classList.add('swap-back-half'); 
                    cell1.style.transform = `translate(${dx / 2}px, ${dy / 2}px)`; 
                    cell2.style.transform = `translate(${-dx / 2}px, ${-dy / 2}px)`; 
                }
                setTimeout(() => {
                    if (!isBackSwap) { 
                        cell1.classList.remove('swap'); cell2.classList.remove('swap'); 
                        cell1.style.transform = ''; cell2.style.transform = ''; 
                        if (callback) callback(); 
                    } else { 
                        cell1.classList.remove('swap-back-half'); cell2.classList.remove('swap-back-half'); 
                        cell1.classList.add('swap-back'); cell2.classList.add('swap-back'); 
                        cell1.style.transform = ''; cell2.style.transform = ''; 
                        setTimeout(() => { 
                            cell1.classList.remove('swap-back'); cell2.classList.remove('swap-back'); 
                            if (callback) callback(); 
                            gameContext.isProcessingMove = false; 
                            if (!gameContext.isFinishingSequence) { 
                                gameContext.setGameActive(gameContext.gameStarted && gameContext.timeLeft > 0 && !gameContext.isGamePausedForShuffle); 
                            }
                        }, animationTime);
                    }
                }, animationTime);
            };
            gameContext.handleCellClick = function(r, c) {
                if (gameContext.isFinishingSequence) return; 
                if (gameContext.isProcessingMove || !gameContext.gameStarted || gameContext.timeLeft <= 0 || gameContext.isGamePausedForShuffle) return; 
                
                gameContext.playClickSound(); 
                if (!gameContext.selected) { 
                    gameContext.selected = [r, c]; 
                    gameContext.renderBoard(); return; 
                }
                const [sr, sc] = gameContext.selected; 
                if (sr === r && sc === c) { 
                    gameContext.selected = null; 
                    gameContext.renderBoard(); return; 
                }
                if (Math.abs(sr - r) + Math.abs(sc - c) === 1) { 
                    gameContext.isProcessingMove = true; gameContext.setGameActive(false); 
                    gameContext.selected = null; gameContext.renderBoard(); 
                    setTimeout(() => { gameContext.animateSwap(sr, sc, r, c, false, () => {
                        gameContext.swap(sr, sc, r, c); 
                        if (gameContext.findMatchesOnBoard(gameContext.board).length > 0) { 
                            gameContext.resetHint(); 
                            gameContext.hintUsedAndNotResolved = false; 
                            setTimeout(gameContext.processMatches, 50); 
                        } else { 
                            gameContext.swap(sr, sc, r, c); 
                            gameContext.playErrorSound(); 
                            gameContext.animateSwap(sr, sc, r, c, true, () => { gameContext.renderBoard(); }); 
                        }
                    }); }, 10); 
                } else { 
                    gameContext.selected = [r, c]; 
                    gameContext.renderBoard(); 
                }
            };
            gameContext.swap = function(r1, c1, r2, c2) {
                const temp = gameContext.board[r1][c1]; 
                gameContext.board[r1][c1] = gameContext.board[r2][c2]; 
                gameContext.board[r2][c2] = temp;
            };
            gameContext.checkMatchAt = function(r_check, c_check, targetBoard) {
                if (r_check < 0 || r_check >= gameContext.size || c_check < 0 || c_check >= gameContext.size) return false;
                const val = targetBoard[r_check][c_check]; if (val === null) return false; 
                
                let h_count = 1;
                for (let i = c_check - 1; i >= 0 && targetBoard[r_check][i] === val; i--) h_count++; 
                for (let i = c_check + 1; i < gameContext.size && targetBoard[r_check][i] === val; i++) h_count++; 
                if (h_count >= 3) return true;
                
                let v_count = 1;
                for (let i = r_check - 1; i >= 0 && targetBoard[i][c_check] === val; i--) v_count++; 
                for (let i = r_check + 1; i < gameContext.size && targetBoard[i][c_check] === val; i++) v_count++; 
                if (v_count >= 3) return true; 
                
                return false;
            };
            gameContext.findMatchesOnBoard = function(currentBoard) {
                let matches = [];
                for (let r = 0; r < gameContext.size; r++) { 
                    for (let c = 0; c < gameContext.size - 2; c++) { 
                        if (currentBoard[r][c] !== null && currentBoard[r][c] === currentBoard[r][c+1] && currentBoard[r][c] === currentBoard[r][c+2]) { 
                            let len = 3; 
                            while (c + len < gameContext.size && currentBoard[r][c] === currentBoard[r][c+len]) { len++; } 
                            matches.push({r, c, len, dir: 'h'}); 
                            c += len -1; 
                        } 
                    } 
                }
                for (let c = 0; c < gameContext.size; c++) { 
                    for (let r = 0; r < gameContext.size - 2; r++) { 
                        if (currentBoard[r][c] !== null && currentBoard[r][c] === currentBoard[r+1][c] && currentBoard[r][c] === currentBoard[r+2][c]) { 
                            let len = 3; 
                            while (r + len < gameContext.size && currentBoard[r][c] === currentBoard[r+len][c]) { len++; } 
                            matches.push({r, c, len, dir: 'v'}); 
                            r += len -1; 
                        } 
                    } 
                } return matches;
            };
            gameContext.shuffleBoard = function() {
                let flatBoard = gameContext.board.flat(); 
                let attempts = 0; const MAX_ATTEMPTS = 20; 
                while (attempts < MAX_ATTEMPTS) {
                    for (let i = flatBoard.length - 1; i > 0; i--) { 
                        const j = Math.floor(Math.random() * (i + 1)); 
                        [flatBoard[i], flatBoard[j]] = [flatBoard[j], flatBoard[i]]; 
                    }
                    let currentAttemptBoard = []; 
                    for (let i = 0; i < gameContext.size; i++) { 
                        currentAttemptBoard.push(flatBoard.slice(i * gameContext.size, (i + 1) * gameContext.size)); 
                    }
                    if (gameContext.findMatchesOnBoard(currentAttemptBoard).length === 0 && gameContext.findHintPairOnBoard(currentAttemptBoard)) { 
                        gameContext.board = currentAttemptBoard; 
                        return; 
                    } 
                    attempts++;
                } 
                gameContext.createBoard(); 
            };
            gameContext.handleShuffleConfirmation = function() {
                if (gameContext.messageBoxOverlay) gameContext.messageBoxOverlay.classList.remove('visible'); 
                updateBackButtonVisibility(); 
                gameContext.shuffleBoard(); 
                gameContext.isGamePausedForShuffle = false; gameContext.isProcessingMove = false; 
                if (!gameContext.isFinishingSequence) { 
                    gameContext.setGameActive(true); 
                    if (gameContext.gameStarted && gameContext.timeLeft > 0) { gameContext.startTimer(); } 
                }
                gameContext.renderBoard(); 
                gameContext.updateUI();
            };
            gameContext.processMatches = function() {
                gameContext.isProcessingMove = true; 
                let matches = gameContext.findMatchesOnBoard(gameContext.board);

                if (matches.length === 0) { 
                    if (gameContext.isFinishingSequence) { 
                        gameContext.finalizeGameEnd(); 
                        return; 
                    }
                    if (gameContext.gameStarted && gameContext.timeLeft > 0 && !gameContext.isGamePausedForShuffle) {
                       if (!gameContext.findHintPairOnBoard(gameContext.board)) { 
                            gameContext.isGamePausedForShuffle = true; 
                            gameContext.setGameActive(false); 
                            clearInterval(gameContext.timerInterval); 
                            gameContext.xxl_showMessage("æ£‹ç›˜ä¸Šæ²¡æœ‰å¯ç§»åŠ¨çš„ç»„åˆäº†ï¼ç‚¹å‡»â€œå¥½â€å°†ä¸ºæ‚¨æ´—ç‰Œã€‚", gameContext.handleShuffleConfirmation); 
                            return;
                        }
                    } 
                    gameContext.isProcessingMove = false; 
                    if (!gameContext.isFinishingSequence) { 
                        gameContext.setGameActive(gameContext.gameStarted && gameContext.timeLeft > 0 && !gameContext.isGamePausedForShuffle);
                    }
                    gameContext.renderBoard(); 
                    return;
                } 
                
                gameContext.resetHint(); 
                gameContext.hintUsedAndNotResolved = false; 

                let removed = Array.from({length: gameContext.size}, () => Array(gameContext.size).fill(false)); 
                let currentMatchScore = 0;
                for (const m of matches) { 
                    for (let i = 0; i < m.len; i++) { 
                        let r = m.dir === 'h' ? m.r : m.r + i; 
                        let c = m.dir === 'h' ? m.c + i : m.c; 
                        if (!removed[r][c]) { removed[r][c] = true; currentMatchScore += 10; } 
                    } 
                }
                gameContext.score += currentMatchScore; 
                if (currentMatchScore > 0) { gameContext.playMatchSound(); } 
                gameContext.updateUI(); 
                gameContext.renderBoard(removed); 
                
                setTimeout(() => {
                    for (let r = 0; r < gameContext.size; r++) { for (let c = 0; c < gameContext.size; c++) { if (removed[r][c]) { gameContext.board[r][c] = null; } } }
                    
                    let fallMap = Array.from({length: gameContext.size}, () => Array(gameContext.size).fill(false)); 
                    for (let c = 0; c < gameContext.size; c++) { 
                        let emptySlots = 0; 
                        for (let r = gameContext.size - 1; r >= 0; r--) { 
                            if (gameContext.board[r][c] === null) { emptySlots++; } 
                            else if (emptySlots > 0) { 
                                gameContext.board[r + emptySlots][c] = gameContext.board[r][c]; 
                                gameContext.board[r][c] = null; 
                                fallMap[r + emptySlots][c] = true; 
                            } 
                        } 
                    } 
                    for (let c = 0; c < gameContext.size; c++) { 
                        for (let r = 0; r < gameContext.size; r++) { 
                            if (gameContext.board[r][c] === null) {
                                let placedItem = -1; 
                                let randomChoice = Math.random();
                                if (randomChoice < gameContext.R_AUTO_MATCH) { 
                                    for (let imgIndex = 0; imgIndex < gameContext.images.length; imgIndex++) { 
                                        gameContext.board[r][c] = imgIndex; 
                                        if (gameContext.checkMatchAt(r, c, gameContext.board)) { placedItem = imgIndex; break; } 
                                    } 
                                    if (placedItem === -1) gameContext.board[r][c] = null; 
                                }
                                if (placedItem === -1 && randomChoice >= gameContext.R_AUTO_MATCH && randomChoice < gameContext.R_AUTO_MATCH + gameContext.R_SETUP_MOVE) {
                                    let tempBoardForSetup = gameContext.board.map(row => [...row]); 
                                    for (let imgIndex = 0; imgIndex < gameContext.images.length; imgIndex++) { 
                                        tempBoardForSetup[r][c] = imgIndex; 
                                        const directions = [[0,1],[1,0], [0,-1], [-1,0]]; 
                                        for (const [dr_s, dc_s] of directions) { 
                                            let nr_s = r + dr_s; let nc_s = c + dc_s; 
                                            if (nr_s >= 0 && nr_s < gameContext.size && nc_s >= 0 && nc_s < gameContext.size && tempBoardForSetup[nr_s][nc_s] !== null) {
                                                let tempVal = tempBoardForSetup[r][c]; tempBoardForSetup[r][c] = tempBoardForSetup[nr_s][nc_s]; tempBoardForSetup[nr_s][nc_s] = tempVal;
                                                if (gameContext.findMatchesOnBoard(tempBoardForSetup).length > 0) { 
                                                    placedItem = imgIndex; 
                                                    tempVal = tempBoardForSetup[r][c]; tempBoardForSetup[r][c] = tempBoardForSetup[nr_s][nc_s]; tempBoardForSetup[nr_s][nc_s] = tempVal; 
                                                    break; 
                                                }
                                                tempVal = tempBoardForSetup[r][c]; tempBoardForSetup[r][c] = tempBoardForSetup[nr_s][nc_s]; tempBoardForSetup[nr_s][nc_s] = tempVal; 
                                            } 
                                        } 
                                        if (placedItem !== -1) break; 
                                    }
                                }
                                if (placedItem !== -1) { gameContext.board[r][c] = placedItem; } 
                                else { 
                                    let attempts = 0; const maxAttempts = gameContext.images.length * 2; 
                                    while(attempts < maxAttempts) { 
                                        let imgIdx = gameContext.randomImage(); 
                                        gameContext.board[r][c] = imgIdx; 
                                        if (!gameContext.checkMatchAt(r, c, gameContext.board)) { break; } 
                                        attempts++; 
                                    } 
                                    if (attempts === maxAttempts) { gameContext.board[r][c] = gameContext.randomImage(); } 
                                } 
                                fallMap[r][c] = true; 
                            } 
                        } 
                    } 
                    gameContext.renderBoard(null, fallMap); 
                    setTimeout(gameContext.processMatches, 400); 
                }, 400); 
            };

            gameContext.startTimer = function() {
                if (gameContext.timerInterval) clearInterval(gameContext.timerInterval); 
                if(gameContext.timerEl) gameContext.timerEl.textContent = `å‰©ä½™æ—¶é—´ï¼š${gameContext.timeLeft}ç§’`;
                
                gameContext.timerInterval = setInterval(() => {
                    if (gameContext.isGamePausedForShuffle || gameContext.isFinishingSequence) { 
                        if (gameContext.isFinishingSequence && gameContext.timeLeft <=0 && !gameContext.isProcessingMove) {
                            gameContext.finalizeGameEnd();
                        }
                        return;
                    }

                    gameContext.timeLeft--; 
                    gameContext.updateUI(); 

                    if (gameContext.timeLeft <= 0) { 
                        clearInterval(gameContext.timerInterval); 
                        if(gameContext.timerEl) gameContext.timerEl.textContent = 'æ—¶é—´åˆ°ï¼';
                        gameContext.isFinishingSequence = true; 
                        
                        if (!gameContext.isProcessingMove) {
                            gameContext.finalizeGameEnd();
                        } 
                    }
                }, 1000);
            };
            
            gameContext.finalizeGameEnd = function() {
                if (gameContext.timerInterval) clearInterval(gameContext.timerInterval); 
                
                gameContext.gameStarted = false; 
                gameContext.matchGameCompletedOnce = true; 
                window.matchGameContext.hasEverCompletedMatchGame = true; 
                
                const messageAlreadyShown = gameContext.messageBoxOverlay && gameContext.messageBoxOverlay.classList.contains('visible') && 
                                         gameContext.messageBoxText && gameContext.messageBoxText.textContent && 
                                         gameContext.messageBoxText.textContent.startsWith("æ—¶é—´åˆ°ï¼ä½ çš„æœ€ç»ˆåˆ†æ•°æ˜¯ï¼š");

                if (!messageAlreadyShown) {
                     gameContext.xxl_showMessage(`æ—¶é—´åˆ°ï¼ä½ çš„æœ€ç»ˆåˆ†æ•°æ˜¯ï¼š${gameContext.score}`);
                }
                
                gameContext.isFinishingSequence = false; 
                gameContext.isProcessingMove = false; 

                gameContext.resetHint(); 

                if(gameContext.actionBtn) {
                    gameContext.actionBtn.textContent = 'å†æ¥ä¸€æ¬¡'; 
                }
                if(gameContext.matchGameToProductsBtn) {
                    gameContext.matchGameToProductsBtn.style.display = 'inline-block'; 
                }
                
                gameContext.updateUI(); 
                gameContext.setGameActive(false); 
            };

            gameContext.resetHint = function() {
                if (gameContext.hintPair) { 
                    const oldHintPair = gameContext.hintPair;
                    gameContext.hintPair = null; 
                    if (gameContext.boardEl && gameContext.boardEl.children.length > 0) {
                        [oldHintPair[0], oldHintPair[1]].forEach(pos => {
                            const cellIndex = pos[0] * gameContext.size + pos[1];
                            const cellElement = gameContext.boardEl.children[cellIndex];
                            if (cellElement) {
                                cellElement.classList.remove('hint', 'hint-animate');
                                cellElement.style.removeProperty('--xxl-hint-x'); 
                                cellElement.style.removeProperty('--xxl-hint-y');
                            }
                        });
                    } else { gameContext.renderBoard(); } 
                }
                 gameContext._xxlHintSwap = false; 
            };
            gameContext.findHintPairOnBoard = function(currentBoard) {
                for (let r = 0; r < gameContext.size; r++) { for (let c = 0; c < gameContext.size; c++) {
                    if (c < gameContext.size - 1) { 
                        let temp = currentBoard[r][c]; currentBoard[r][c] = currentBoard[r][c+1]; currentBoard[r][c+1] = temp; 
                        if (gameContext.findMatchesOnBoard(currentBoard).length > 0) { 
                            temp = currentBoard[r][c]; currentBoard[r][c] = currentBoard[r][c+1]; currentBoard[r][c+1] = temp; 
                            return [[r,c],[r,c+1]]; 
                        } 
                        temp = currentBoard[r][c]; currentBoard[r][c] = currentBoard[r][c+1]; currentBoard[r][c+1] = temp; 
                    }
                    if (r < gameContext.size - 1) { 
                        let temp = currentBoard[r][c]; currentBoard[r][c] = currentBoard[r+1][c]; currentBoard[r+1][c] = temp; 
                        if (gameContext.findMatchesOnBoard(currentBoard).length > 0) { 
                            temp = currentBoard[r][c]; currentBoard[r][c] = currentBoard[r+1][c]; currentBoard[r+1][c] = temp; 
                            return [[r,c],[r+1,c]]; 
                        } 
                        temp = currentBoard[r][c]; currentBoard[r][c] = currentBoard[r+1][c]; currentBoard[r+1][c] = temp; 
                    }
                } } return null; 
            };
            gameContext.handleHint = function() {
                if (gameContext.isFinishingSequence || gameContext.hintCount <= 0 || !gameContext.gameStarted || gameContext.timeLeft <= 0 || gameContext.isProcessingMove || gameContext.isGamePausedForShuffle || gameContext.hintUsedAndNotResolved) return;
                
                let tempBoard = gameContext.board.map(row => [...row]); 
                gameContext.hintPair = gameContext.findHintPairOnBoard(tempBoard); 
                
                if (gameContext.hintPair) { 
                    gameContext.hintCount--; 
                    gameContext.hintUsedAndNotResolved = true; 
                    gameContext.updateUI(); 
                    gameContext._xxlHintSwap = true; 
                    gameContext.renderBoard(); 
                    setTimeout(() => { 
                        gameContext._xxlHintSwap = false; 
                        gameContext.renderBoard(); 
                    }, 1200); 
                } else { 
                    gameContext.xxl_showMessage('å½“å‰æ²¡æœ‰å¯æ¶ˆé™¤çš„ç»„åˆï¼'); 
                }
            };
            
            gameContext.startGame = async function() {
                if (!gameContext.soundsInitialized && typeof Tone !== 'undefined') { 
                    try { await Tone.start(); gameContext.initializeToneSounds(); } 
                    catch (e) { console.error("Failed to start Tone.js for match game:", e); gameContext.initializeToneSounds();  } 
                } else if (!gameContext.soundsInitialized) { 
                    gameContext.initializeToneSounds(); 
                }
                
                gameContext.score = 0; 
                gameContext.timeLeft = gameContext.gameDuration; 
                gameContext.hintCount = gameContext.initialHintCount;
                gameContext.selected = null; 
                gameContext.isProcessingMove = false; 
                gameContext.isGamePausedForShuffle = false;
                gameContext.matchGameCompletedOnce = false; 
                gameContext.isFinishingSequence = false; 
                gameContext.hintUsedAndNotResolved = false; 

                if (gameContext.timerInterval) clearInterval(gameContext.timerInterval); 
                if(gameContext.messageBoxOverlay) gameContext.messageBoxOverlay.classList.remove('visible'); 
                updateBackButtonVisibility(); 
                
                gameContext.createBoard(); 
                
                gameContext.renderBoard(); 
                
                gameContext.gameStarted = true; 
                gameContext.setGameActive(true); 
                gameContext.startTimer(); 
                gameContext.updateUI(); 
                if(gameContext.actionBtn) gameContext.actionBtn.textContent = 'æ¸¸æˆä¸­...'; 
            };


            gameContext.prepareForView = function() {
                gameContext.setupBoardSize(); 
                gameContext.resetHint();      

                if (window.matchGameContext.hasEverCompletedMatchGame) { 
                    if(gameContext.actionBtn) {
                        gameContext.actionBtn.textContent = 'å†æ¥ä¸€æ¬¡'; 
                    }
                    if(gameContext.matchGameToProductsBtn) {
                        gameContext.matchGameToProductsBtn.style.display = 'inline-block'; 
                    }
                    if (!gameContext.gameStarted && !gameContext.isFinishingSequence) {
                        gameContext.timeLeft = gameContext.gameDuration;
                        gameContext.score = 0;
                        gameContext.hintCount = gameContext.initialHintCount;
                        if (!gameContext.board || gameContext.board.length === 0) { 
                           gameContext.createBoard(); 
                        }
                    }
                } else { 
                    gameContext.timeLeft = gameContext.gameDuration;
                    gameContext.score = 0;
                    gameContext.hintCount = gameContext.initialHintCount;
                    if(gameContext.actionBtn) {
                         gameContext.actionBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
                    }
                    if(gameContext.matchGameToProductsBtn) {
                        gameContext.matchGameToProductsBtn.style.display = 'none'; 
                    }
                    if (!gameContext.gameStarted && !gameContext.isFinishingSequence) {
                         if (!gameContext.board || gameContext.board.length === 0) { 
                            gameContext.createBoard(); 
                        }
                    }
                }
                gameContext.isFinishingSequence = false; 
                gameContext.isProcessingMove = false; 
                gameContext.hintUsedAndNotResolved = false; 

                if(gameContext.timerEl) gameContext.timerEl.textContent = `å‰©ä½™æ—¶é—´ï¼š${gameContext.timeLeft}ç§’`;
                
                if (gameContext.matchGameMusicIcon) {
                    const iconSrc = gameContext.isMatchGameMusicOn ? 'music_on.png' : 'music_off.png';
                    gameContext.matchGameMusicIcon.src = iconSrc;
                    gameContext.matchGameMusicIcon.alt = gameContext.isMatchGameMusicOn ? 'Music On' : 'Music Off';
                    gameContext.matchGameMusicIcon.onerror = () => { 
                        gameContext.matchGameMusicIcon.parentElement.innerHTML = `<span style="font-size:12px;">ğŸµ${gameContext.isMatchGameMusicOn ? 'On':'Off'}</span>`;
                     };
                }

                gameContext.renderBoard(); 
                gameContext.updateUI(); 
                gameContext.setGameActive(gameContext.gameStarted && !gameContext.isFinishingSequence); 
            };


            if(gameContext.matchGameMusicToggleBtn && gameContext.matchGameMusicIcon) {
                gameContext.matchGameMusicToggleBtn.onclick = () => {
                    gameContext.isMatchGameMusicOn = !gameContext.isMatchGameMusicOn;
                    const newIconSrc = gameContext.isMatchGameMusicOn ? 'music_on.png' : 'music_off.png';
                    gameContext.matchGameMusicIcon.src = newIconSrc;
                    gameContext.matchGameMusicIcon.alt = gameContext.isMatchGameMusicOn ? 'Music On' : 'Music Off';
                    gameContext.matchGameMusicIcon.onerror = () => {
                        gameContext.matchGameMusicIcon.parentElement.innerHTML = `<span style="font-size:12px;">ğŸµ${gameContext.isMatchGameMusicOn ? 'On':'Off'}</span>`;
                    };
                };
            }
            
            gameContext.setupBoardSize(); 
            if (!gameContext.board || gameContext.board.length === 0) { 
                 gameContext.createBoard(); 
            }
            gameContext.prepareForView(); 

            if(gameContext.actionBtn) {
                gameContext.actionBtn.onclick = function() { 
                    if ((gameContext.isProcessingMove && !gameContext.isGamePausedForShuffle) || gameContext.isFinishingSequence) return; 
                    gameContext.startGame(); 
                };
            }
            if(gameContext.hintBtn) { 
                gameContext.hintBtn.onclick = gameContext.handleHint; 
            }
            if(gameContext.matchGameToProductsBtn) {
                gameContext.matchGameToProductsBtn.onclick = () => navigateTo('section-products');
            }
        } 


        // --- DOMContentLoaded: Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const welcomeSection = document.getElementById('section-welcome');
            if (welcomeSection) welcomeSection.classList.add('active-section'); 
            else console.error("Welcome section not found on DOMContentLoaded");
            updateBackButtonVisibility(); 

            document.querySelectorAll('.product-item').forEach(item => {
                const staticDescEl = item.querySelector('p.static-description');
                if (staticDescEl && item.dataset.description) {
                    staticDescEl.innerHTML = item.dataset.description.replace(/\n/g, '<br>');
                }
            });

            if (clickGameMusicIcon) {
                const initialClickIconSrc = isClickGameMusicOn ? 'music_on.png' : 'music_off.png';
                clickGameMusicIcon.src = initialClickIconSrc; clickGameMusicIcon.alt = isClickGameMusicOn ? 'Music On' : 'Music Off';
                clickGameMusicIcon.onerror = () => {
                    clickGameMusicIcon.parentElement.innerHTML = `<span style="font-size:12px;">ğŸµ${isClickGameMusicOn ? 'On':'Off'}</span>`;
                };
            }
            if (mazeGameMusicIcon) {
                const initialMazeIconSrc = isMazeMusicOn ? 'music_on.png' : 'music_off.png';
                mazeGameMusicIcon.src = initialMazeIconSrc; mazeGameMusicIcon.alt = isMazeMusicOn ? 'Music On' : 'Music Off';
                mazeGameMusicIcon.onerror = () => {
                    mazeGameMusicIcon.parentElement.innerHTML = `<span style="font-size:12px;">ğŸµ${isMazeMusicOn ? 'On':'Off'}</span>`;
                };
            }
        });

        // --- Global Click Listener (MODIFIED FOR STRICTER MODALS) ---
        window.onclick = function(event) {
            // This function is intentionally left mostly empty to prevent modals
            // from closing when clicking on their overlays/backgrounds.
            // Modals should only be closed via their explicit close buttons.
        }
    </script>
</body>
</html>
